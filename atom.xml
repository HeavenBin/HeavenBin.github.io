<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hexo</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2018-02-11T07:19:32.354Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>John Doe</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2018/02/11/hello-world/"/>
    <id>http://yoursite.com/2018/02/11/hello-world/</id>
    <published>2018-02-11T05:55:35.860Z</published>
    <updated>2018-02-11T07:19:32.354Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/
      
    
    </summary>
    
      <category term="这是分类" scheme="http://yoursite.com/categories/%E8%BF%99%E6%98%AF%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="这是标签" scheme="http://yoursite.com/tags/%E8%BF%99%E6%98%AF%E6%A0%87%E7%AD%BE/"/>
    
  </entry>
  
  <entry>
    <title>空格</title>
    <link href="http://yoursite.com/2016/09/09/space/"/>
    <id>http://yoursite.com/2016/09/09/space/</id>
    <published>2016-09-08T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><p>Unicode定义的空格符号如下：</p><p>[\u0020\u00A0\u1680\u180E\u2002-\u200D\u202F\u205F\u2060\u3000\uFEFF]</p><p>以下几种空格可以重点留意：</p><ul><li>\u0020为普通半角空格</li><li>\u00A0为不换行的空格，对应HTML的&nbsp;(No-Break Space)</li><li>\u200B为零宽空格（Zero Width Space）</li><li>\uFEFF为零宽不换行空格（Zero Width No-Break Space）</li></ul><p>其中\u2060为Unicode 3.2新增。</p><p>在移除字符串首尾空白时，我们看看TJ的<a href="https://www.npmjs.com/package/trim" target="_blank" rel="noopener">trim</a>:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trim</span>(<span class="params">str</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> str.replace(<span class="regexp">/^\s*|\s*$/g</span>, <span class="string">''</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>别看这个库如此简单，但是每天的下载量达到1W+。先不说其它方面的BUG，就正则来说问题就不少。<br><code>\s</code>匹配一个空白字符，等价于：</p><p>[\f\n\r\t\v\u00A0\u0020\u1680\u180E\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]</p><p>可以看出很多第三方库在移除首尾空白时都没有考虑周全。<br>下面我们看看浏览器内置的trim又是怎样的？</p><p>示例代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">'\u0020\u00A0\u1680\u180E\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u200B\u200C\u200D\u202F\u205F\u2060\u3000\uFEFF'</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; s.length; i += <span class="number">1</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (s[i].trim().length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'\\u'</span> + s.charCodeAt(i).toString(<span class="number">16</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果如下：</p><ul><li>\u200b</li><li>\u200c</li><li>\u200d</li><li>\u2060</li></ul><p>结论很明朗：浏览器内置的trim也并非100%准确，所以我推荐在严格场景下面使用自定义的trim函数。</p><p><a href="https://repl.it/DZhG/2" target="_blank" rel="noopener">查看在线示例</a></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://zh.wikipedia.org/wiki/%E7%A9%BA%E6%A0%BC" target="_blank" rel="noopener">维基百科 - 空格</a></li></ul><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;p&gt;Unicode定义的空格符号如下：&lt;/p&gt;&lt;p&gt;[\u0020\u00A0\u1680\u180E\u2002-\u200D\u202F\u205F\
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>JavaScript Parser资源总结</title>
    <link href="http://yoursite.com/2016/07/17/parser/"/>
    <id>http://yoursite.com/2016/07/17/parser/</id>
    <published>2016-07-16T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><h2 id="理解抽象语法树-AST"><a href="#理解抽象语法树-AST" class="headerlink" title="理解抽象语法树(AST)"></a>理解抽象语法树(AST)</h2><p><a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="noopener">Abstract syntax tree - 维基百科</a></p><p><a href="http://tech.meituan.com/abstract-syntax-tree.html" target="_blank" rel="noopener">抽象语法树在 JavaScript 中的应用 - 美团点评技术团队</a></p><p><a href="http://wwsun.github.io/posts/javascript-ast-tutorial.html" target="_blank" rel="noopener">JavaScript的抽象语法树与语法解析</a></p><p><a href="http://www.zcfy.cc/article/347" target="_blank" rel="noopener">通过开发 Babel 插件理解抽象语法树</a></p><h2 id="JavaScript-Parser"><a href="#JavaScript-Parser" class="headerlink" title="JavaScript Parser"></a>JavaScript Parser</h2><ul><li><a href="http://esprima.org/" target="_blank" rel="noopener">Esprima</a></li><li><a href="https://github.com/ternjs/acorn" target="_blank" rel="noopener">Acorn</a></li><li><a href="https://github.com/babel/babylon" target="_blank" rel="noopener">Babylon</a></li></ul><p>Parser建议从Esprima开始学习，相比较于其它Parser文档和示例更加丰富和形象。</p><p>Acorn的性能和效率比Esprima更胜一筹，但是文档比较匮乏。</p><p>Babylon是Babel的JavaScript Parser，早期也是fork的Acorn，目前关注度不及其它Parser。</p><p>推荐一种比较好的实践方式：从npm中的找出几个<a href="https://www.npmjs.com/browse/depended/acorn" target="_blank" rel="noopener">依赖于这些Parser</a>的项目直接学习源代码。比如<a href="https://www.npmjs.com/package/amd2cmd" target="_blank" rel="noopener">amd2cmd</a>这个项目就是使用acorn将amd代码转换为cmd代码。</p><h2 id="周边工具"><a href="#周边工具" class="headerlink" title="周边工具"></a>周边工具</h2><p><a href="https://astexplorer.net/" target="_blank" rel="noopener">AST explorer</a></p><p>更直观的理解各个Parser生成的AST。</p><p><a href="https://github.com/estools" target="_blank" rel="noopener">ECMAScript Tooling</a></p><p>各种用于AST以及辅助的相关工具，比如<a href="https://github.com/estools/estraverse" target="_blank" rel="noopener">estraverse</a>用于遍历AST，<a href="https://github.com/estools/escodegen" target="_blank" rel="noopener">escodegen</a>用于从AST生成源代码。</p><p><a href="https://github.com/thejameskyle/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md" target="_blank" rel="noopener">Babel 插件手册</a></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;h2 id=&quot;理解抽象语法树-AST&quot;&gt;&lt;a href=&quot;#理解抽象语法树-AST&quot; class=&quot;headerlink&quot; title=&quot;理解抽象语法树(
      
    
    </summary>
    
    
      <category term="JavaScript,解析器" scheme="http://yoursite.com/tags/JavaScript-%E8%A7%A3%E6%9E%90%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>使用SlimerJS将网页输出为PDF</title>
    <link href="http://yoursite.com/2016/06/29/slimerjs/"/>
    <id>http://yoursite.com/2016/06/29/slimerjs/</id>
    <published>2016-06-28T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><p>本文主要介绍本人在项目实践中通过<code>SlimerJS</code>将网页输出为PDF文档的过程，生成的PDF文档中的文本是矢量的，可以选择复制。<br>虽然网上也有一些类似的分享，但是并没有将整个过程中的可能遇到的坑以及在Web开发中的一些技术细节讲述的比较清楚。</p><h2 id="软件清单："><a href="#软件清单：" class="headerlink" title="软件清单："></a>软件清单：</h2><ul><li>xvfb</li><li>gtk3</li><li>cups</li><li>firefox</li><li>slimerjs</li></ul><p>本文使用的操作系统版本为CentOS 7.2。</p><h2 id="安装xvfb"><a href="#安装xvfb" class="headerlink" title="安装xvfb"></a>安装xvfb</h2><p>关于xvfb的介绍可以查看<a href="https://en.wikipedia.org/wiki/Xvfb" target="_blank" rel="noopener">wiki</a>，简单点说它就是用于处理程序中与图形化相关的功能，但是它不会在屏幕上展示任何图形输出。<br>安装以后可以使用<strong>xvfb-run</strong>命令来运行<strong>headless slimerjs.</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install xorg-x11-server-Xvfb</span><br></pre></td></tr></table></figure><h2 id="安装Firefox"><a href="#安装Firefox" class="headerlink" title="安装Firefox"></a>安装Firefox</h2><p>SlimerJS依赖于Firefox，目前支持的版本号介于38~ 46，其它版本官方无法保证测试结果。<br>所以不推荐安装大于46或者小于38的版本。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://ftp.mozilla.org/pub/firefox/releases/46.0.1/linux-x86_64-EME-free/zh-CN/firefox-46.0.1.tar.bz2</span><br><span class="line">tar xjvf firefox-46.0.1.tar.bz2</span><br></pre></td></tr></table></figure><p>注意这里我们下载Firefox的版本号为64的<a href="https://wiki.mozilla.org/Media/EME" target="_blank" rel="noopener">EME</a>版本，普通版本在渲染复杂网页时可能会出现莫名的引擎级别错误。</p><h2 id="安装GTK3"><a href="#安装GTK3" class="headerlink" title="安装GTK3"></a>安装GTK3</h2><p>由于Firefox 46<a href="https://www.mozilla.org/en-US/firefox/46.0/system-requirements/" target="_blank" rel="noopener">依赖</a>于GTK3，所以这里我们需要安装GTK3。<br>另外如果你的操作系统版本为CentOS 6.x，那么我推荐你<a href="http://itvision.altervista.org/compiling-and-installing-gtk3-in-centos6.html" target="_blank" rel="noopener">放弃安装GTK3</a>，而是直接升级系统。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gtk3-devel</span><br></pre></td></tr></table></figure><h2 id="安装CUPS"><a href="#安装CUPS" class="headerlink" title="安装CUPS"></a>安装CUPS</h2><p><a href="https://www.cups.org/" target="_blank" rel="noopener">CUPS</a>是由苹果开发的通用Unix打印系统，如果没有安装CUPS，SlimerJS将网页渲染为PDF的时候将会<a href="https://docs.slimerjs.org/current/faq.html#on-linux-pdf-rendering-hangs-slimerjs" target="_blank" rel="noopener">挂起</a>。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install cups</span><br></pre></td></tr></table></figure><h2 id="安装SlimerJS"><a href="#安装SlimerJS" class="headerlink" title="安装SlimerJS"></a>安装SlimerJS</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.slimerjs.org/releases/0.10.0/slimerjs-0.10.0.zip</span><br><span class="line">unzip slimerjs-0.10.0.zip</span><br></pre></td></tr></table></figure><h2 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 这里设置为firefox文件夹下的的firefox可执行文件的路径</span><br><span class="line">export SLIMERJSLAUNCHER=PATH_TO_FIREFOX</span><br></pre></td></tr></table></figure><h2 id="开始执行"><a href="#开始执行" class="headerlink" title="开始执行"></a>开始执行</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd PATH_TO_SLIMERJS</span><br><span class="line">xvfb-run ./slimerjs SCRIPT_PATH HTTP_PAGE_URL OUTPUT_FILENAME</span><br></pre></td></tr></table></figure><p>另外如果执行没有正常运行，可以加上—debug参数</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xvfb-run ./slimerjs --debug test.js http://www.qq.com/ test.pdf</span><br></pre></td></tr></table></figure><h2 id="参考代码"><a href="#参考代码" class="headerlink" title="参考代码"></a>参考代码</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">'webpage'</span>).create()</span><br><span class="line"><span class="keyword">var</span> system = <span class="built_in">require</span>(<span class="string">'system'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (system.args.length !== <span class="number">3</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Arguments error: xvfb-run ./slimerjs SCRIPT_PATH HTTP_PAGE_URL OUTPUT_FILENAME'</span>)</span><br><span class="line">  slimer.exit()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> url = system.args[<span class="number">1</span>]</span><br><span class="line">  <span class="keyword">var</span> renderPath = system.args[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Page url is '</span> + url)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Output path is '</span> + renderPath)</span><br><span class="line"></span><br><span class="line">  page.paperSize = &#123;</span><br><span class="line">    <span class="comment">// magic number in my project</span></span><br><span class="line">    width: <span class="string">'1500px'</span>,</span><br><span class="line">    height: <span class="string">'1038px'</span>,</span><br><span class="line">    shrinkToFit: <span class="literal">true</span>,</span><br><span class="line">    printBGColors: <span class="literal">true</span>,</span><br><span class="line">    printBGImages: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  page.onLoadFinished = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Finish loading page'</span>)</span><br><span class="line">    <span class="comment">// 有些时候分页不理想，需要删除一些节点</span></span><br><span class="line">    page.evaluate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> nodes = <span class="built_in">document</span>.querySelectorAll(<span class="string">'.bottom-line'</span>)</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i&lt; nodes.length; i += <span class="number">1</span>) &#123;</span><br><span class="line">        nodes[i].parentNode.removeChild(nodes[i])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Start rendering'</span>)</span><br><span class="line">    page.render(renderPath)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Finish rendering'</span>)</span><br><span class="line">    slimer.exit()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Opening page now ...'</span>)</span><br><span class="line">  page.open(url)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="字体"><a href="#字体" class="headerlink" title="字体"></a>字体</h2><p>由于服务部署在Linux服务器上，网页渲染使用的字体与Windows和macOS区别还是很大的，比如Windows的微软雅黑在Linux是无法使用的。<br>另外在安装字体上也有两种选择，第一是直接安装在服务器上，第二是作为Web Fonts从网页中引入。</p><h2 id="Flex布局"><a href="#Flex布局" class="headerlink" title="Flex布局"></a>Flex布局</h2><p>早先我们尝试使用PhantomJS来完成此工作，虽然网上有说2.x支持Flex布局，但是我们的实践结果是不支持。SlimerJS在Flex布局上支持的很好，无需任何额外工作。</p><h2 id="Canvas绘制"><a href="#Canvas绘制" class="headerlink" title="Canvas绘制"></a>Canvas绘制</h2><p>我们的网页使用了ECharts来进行图表绘制，ECharts底层使用了canvas来绘制图表。<br>PhantomJS输出的PDF在这方面支持很差，Stacked Column中莫名的出现很多空白间隙。SlimerJS的表现要好得多，不过有些淡虚线比实际要粗一些，色彩也深一些。</p><h2 id="文档分页"><a href="#文档分页" class="headerlink" title="文档分页"></a>文档分页</h2><p>如果希望输出的PDF能够支持分页输出（方便分页打印），需要设置paperSize的Height来确定每页pdf的高度。<br>不过这里也是有坑的，每页PDF高度会有几个像素的差距，导致会多出一个空白页。</p><h2 id="CSS适配"><a href="#CSS适配" class="headerlink" title="CSS适配"></a>CSS适配</h2><p>渲染PDF的时候，浏览器进入打印模式，如果你没有专门适配样式，输出效果会很差。很多元素的背景颜色/文本颜色/背景图片不会展示出来。<br>对于PhantomJS，网上有讨论说需要加上如下样式（我本人并未实践过此方案）：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">media</span> print &#123;</span><br><span class="line">  <span class="selector-tag">body</span> &#123;</span><br><span class="line">     <span class="comment">/*https://developer.mozilla.org/en-US/docs/Web/CSS/-webkit-print-color-adjust*/</span></span><br><span class="line">     <span class="attribute">-webkit-print-color-adjust</span>: exact;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于SlimerJS，虽然paperSize存在相关设置（printBGColors/printBGImages），但是文本颜色似乎无法设置。所以我推荐在编写CSS的时候注意如下细节：</p><ul><li>将所有背景图片转换为Base64字符串直接在css中引入（幸好有webpack）</li><li>所有设置元素文本颜色和背景颜色的样式需要兼容打印模式</li><li>文本颜色相关的设置不支持inherited，这点尤其注意</li></ul><p>样例代码如下：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.someClassName</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>:red;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#FFF</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="keyword">media</span> print &#123;</span><br><span class="line">  <span class="selector-class">.someClassName</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>:red <span class="meta">!important</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#FFF</span> <span class="meta">!important</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="最后的忠告"><a href="#最后的忠告" class="headerlink" title="最后的忠告"></a>最后的忠告</h2><p><em>不要寄希望于输出的PDF与网页中展示效果100%一致，几乎不可能（尤其是网页内容相对比较复杂的时候），最终效果或多或少都会有些瑕疵。</em></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;p&gt;本文主要介绍本人在项目实践中通过&lt;code&gt;SlimerJS&lt;/code&gt;将网页输出为PDF文档的过程，生成的PDF文档中的文本是矢量的，可以选择复制
      
    
    </summary>
    
    
      <category term="SlimerJS" scheme="http://yoursite.com/tags/SlimerJS/"/>
    
  </entry>
  
  <entry>
    <title>代码管理</title>
    <link href="http://yoursite.com/2016/06/26/code-management/"/>
    <id>http://yoursite.com/2016/06/26/code-management/</id>
    <published>2016-06-25T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><blockquote><p>本文基本总结了我在DataEye前端项目代码管理方面的一些尝试。分享PPT在 <a href="http://slides.com/reduxis/deck-1/fullscreen" target="_blank" rel="noopener">slides.com</a> 可能需要翻墙。</p><h2 id="Virtuality-amp-Reality"><a href="#Virtuality-amp-Reality" class="headerlink" title="Virtuality &amp; Reality"></a>Virtuality &amp; Reality</h2><p>借助于当下流行的VR，代码管理也从两个方面来讲解：虚（文件内容相关的管理）/实（文件的物理存储相关的管理）</p><h2 id="Version-Control"><a href="#Version-Control" class="headerlink" title="Version Control"></a>Version Control</h2><p>Git与SVN：Git是分布式版本管理，SVN是中心化。</p></blockquote><p>无需中心服务器，本地自用</p><blockquote><p>git init</p><h2 id="Multiple-Projects"><a href="#Multiple-Projects" class="headerlink" title="Multiple Projects"></a>Multiple Projects</h2><p>实际工作中开发人员每天都要与多个项目打交道，如何在多项目中开发中提高工作效率值得思考与学习</p><p>20,0000,0000</p><h2 id="All-in-one"><a href="#All-in-one" class="headerlink" title="All in one"></a>All in one</h2><p>和Windows的基础代码很像，Google的20亿行代码是用来驱动整个Google服务的，他们是一个整体！</p></blockquote><p><a href="http://blog.jobbole.com/91648/" target="_blank" rel="noopener">谷歌代码库已超过 20 亿行代码，他们是如何管理的？</a></p><h2 id="All-in-two-indeed"><a href="#All-in-two-indeed" class="headerlink" title="All in two indeed"></a>All in two indeed</h2><blockquote><p>将业务代码(static)和可复用的代码(DataEye/dejs)分离</p><h2 id="Static"><a href="#Static" class="headerlink" title="Static"></a>Static</h2><p>所有的前端业务代码</p><h2 id="DataEye-dejs"><a href="#DataEye-dejs" class="headerlink" title="DataEye/dejs"></a>DataEye/dejs</h2><p>所有复用的组件代码，基于npm进行包管理</p><h2 id="npm"><a href="#npm" class="headerlink" title="npm"></a>npm</h2><p>node package manager → package manager for javascript</p><p>30,1298</p><h2 id="Branches"><a href="#Branches" class="headerlink" title="Branches"></a>Branches</h2><p>分支管理已经成为日常工作的一部分（迭代新特性开发/临时BUG修复等）</p><h2 id="Under-Control"><a href="#Under-Control" class="headerlink" title="Under Control"></a>Under Control</h2><p>分支管理不是复制粘贴，需要微观宏观同时把控。</p><p>提交/文件/修改历史都需要记录在案</p><h2 id="SVN"><a href="#SVN" class="headerlink" title="SVN"></a>SVN</h2><p>你打算签出十个分支的所有代码吗？</p><h2 id="Workflow"><a href="#Workflow" class="headerlink" title="Workflow"></a>Workflow</h2><p>工作流管理将版本库分为稳定分支和临时分支</p><h2 id="Stable-Branches"><a href="#Stable-Branches" class="headerlink" title="Stable Branches"></a>Stable Branches</h2><p>master用于管理已发布的线上代码，development用于日常开发</p><h2 id="Temporary-Branches"><a href="#Temporary-Branches" class="headerlink" title="Temporary Branches"></a>Temporary Branches</h2><p>feature / bug / release</p></blockquote><p>临时分支需要在适当的时机合并到所有稳定分支。</p><h2 id="Code-Review"><a href="#Code-Review" class="headerlink" title="Code Review"></a>Code Review</h2><blockquote><p>发现BUG，提高代码质量，促进知识共享，提升团队技术水平</p><h2 id="Continuous-Integration"><a href="#Continuous-Integration" class="headerlink" title="Continuous Integration"></a>Continuous Integration</h2><p>提高软件质量，降低项目风险</p><h2 id="Unit-Test"><a href="#Unit-Test" class="headerlink" title="Unit Test"></a>Unit Test</h2><p>隔离程序最小单元对其进行正确性测试，避免意外惊喜</p></blockquote><p>单元测试能够反哺程序自身的架构和设计。</p><h2 id="Coverage"><a href="#Coverage" class="headerlink" title="Coverage"></a>Coverage</h2><blockquote><p>没有明显错误的代码 vs 明显没有错误的代码</p></blockquote><p>难以想象一行完全没有运行过的代码发布到生产环境会造成什么后果。</p><h2 id="Advice-on-Commits"><a href="#Advice-on-Commits" class="headerlink" title="Advice on Commits"></a>Advice on Commits</h2><blockquote><p>尽快提交/尽早提交/经常提交</p><h2 id="Advice-on-Coding"><a href="#Advice-on-Coding" class="headerlink" title="Advice on Coding"></a>Advice on Coding</h2><p>Be social and better</p><ul><li>GitHub</li><li>npm</li><li>Upsource</li><li>codecov</li><li>Semaphoreci</li></ul></blockquote><hr><p>本文使用软件 <a href="https://github.com/simongfxu/violet" target="_blank" rel="noopener">violet</a>一键发布到知乎/简书/Medium/GitHub等多个平台。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;blockquote&gt;&lt;p&gt;本文基本总结了我在DataEye前端项目代码管理方面的一些尝试。分享PPT在 &lt;a href=&quot;http://slides.c
      
    
    </summary>
    
    
      <category term="代码管理" scheme="http://yoursite.com/tags/%E4%BB%A3%E7%A0%81%E7%AE%A1%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>violet - 值得一试的写作同步小助手</title>
    <link href="http://yoursite.com/2016/06/18/violet/"/>
    <id>http://yoursite.com/2016/06/18/violet/</id>
    <published>2016-06-17T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><h2 id="她是什么"><a href="#她是什么" class="headerlink" title="她是什么"></a>她是什么</h2><p><em>violet 是一款面向写作爱好者的客户端同步工具。</em></p><p>对于喜欢写点东西的人来说，一般都会活跃在多个写作平台（<code>知乎</code>、<code>简书</code>、<code>Medium</code>、<code>GitHub</code>）。<br>往往我们倾向于在多个平台中选择一个作为主创平台。</p><p><strong>为什么只能选择一个平台？</strong></p><p>因为作品在各个写作平台之间同步异常麻烦。</p><blockquote><p>各个平台编辑器支持能力不一致，人的精力有限，你不可能在每个平台上使用不同的编辑器都发布一遍。<br>即时可以复制粘贴，但大多数时候粘贴出的格式都并非如你所愿（尤其是代码）。<br>随之而来的格式调整会花费大量时间，慢慢地你失去了同步多个平台的动力。<br>作品发布以后频繁的小幅更新也慢慢地在摧毁你的创作动力。</p></blockquote><p><strong>而罪魁祸首仅仅是缺少一款得心应手的工具！</strong></p><p>从今天起就不要为这些问题担忧了，<strong>violet</strong> 能帮你解除后顾之忧。</p><h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><ul><li>统一使用流行的写作语言 <strong>Markdown</strong></li><li>在各大写作平台之间同步作品（<strong>一次编写，处处发布</strong>）<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2></li><li>跨平台，兼容Windows / Mac / Linux</li><li>零网络请求，零客户端数据上报（写作平台接口除外）</li><li>敏感信息加密存储在本地</li><li><a href="https://github.com/simongfxu/violet" target="_blank" rel="noopener">源代码开源</a><h2 id="支持写作平台"><a href="#支持写作平台" class="headerlink" title="支持写作平台"></a>支持写作平台</h2></li><li>知乎</li><li>简书</li><li>Medium</li><li>GitHub</li><li>其它(敬请期待)<h2 id="功能支持"><a href="#功能支持" class="headerlink" title="功能支持"></a>功能支持</h2></li></ul><p>功能支持请前往：<a href="https://jinshuju.net/f/2yctZ5?x_field_1=github" target="_blank" rel="noopener">violet需求调查</a></p><p>产品论坛和意见反馈请前往：<a href="https://violet.kf5.com/hc/" target="_blank" rel="noopener">violet客户支持服务平台</a></p><h2 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h2><p>本文链接：</p><ul><li><a href="https://zhuanlan.zhihu.com/p/21376171?refer=reduxis" target="_blank" rel="noopener">知乎</a></li><li><a href="http://www.jianshu.com/p/d93ca8b61355" target="_blank" rel="noopener">简书</a></li><li><a href="https://github.com/simongfxu/simongfxu.github.com/issues/101" target="_blank" rel="noopener">GitHub</a></li><li><a href="https://medium.com/@damngoto/violet-%E5%80%BC%E5%BE%97%E4%B8%80%E8%AF%95%E7%9A%84%E5%86%99%E4%BD%9C%E5%90%8C%E6%AD%A5%E5%B0%8F%E5%8A%A9%E6%89%8B-2fbd2799cea4" target="_blank" rel="noopener">Medium</a></li></ul><p>截图：</p><p><img src="https://pic2.zhimg.com/153f8d8cda1d4b7b95e53e3375c26fc3_r.png" alt="Linux"></p><h2 id="名称来源"><a href="#名称来源" class="headerlink" title="名称来源"></a>名称来源</h2><p>我初生的女儿叫 <strong>小紫</strong></p><h2 id="License"><a href="#License" class="headerlink" title="License"></a>License</h2><p>MIT</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;h2 id=&quot;她是什么&quot;&gt;&lt;a href=&quot;#她是什么&quot; class=&quot;headerlink&quot; title=&quot;她是什么&quot;&gt;&lt;/a&gt;她是什么&lt;/h2&gt;&lt;p&gt;
      
    
    </summary>
    
    
      <category term="React" scheme="http://yoursite.com/tags/React/"/>
    
  </entry>
  
  <entry>
    <title>Better React 后续</title>
    <link href="http://yoursite.com/2016/03/12/better-react-2/"/>
    <id>http://yoursite.com/2016/03/12/better-react-2/</id>
    <published>2016-03-11T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><p>之前重构项目后根据个人实战经验写了一篇<a href="http://zhuanlan.zhihu.com/reduixs/20554654" target="_blank" rel="noopener">《Better React》</a>，总结在React中传递props应该注意的事项。<br>在后来与网友的讨论中发现行文总结不太严谨，于是乎再度发文，争取纠正其中某些纰漏之处，不至于误导他人。<br>如果你还没有阅读<a href="http://zhuanlan.zhihu.com/reduixs/20554654" target="_blank" rel="noopener">《Better React》</a>，推荐阅读之后再来阅读本文。</p><h2 id="缓存函数作为组件的prop传递不可取吗？"><a href="#缓存函数作为组件的prop传递不可取吗？" class="headerlink" title="缓存函数作为组件的prop传递不可取吗？"></a>缓存函数作为组件的prop传递不可取吗？</h2><p>之前的文章中不推荐缓存函数主要是因为下面这两个原因：</p><ul><li><em>类似的prop越多，外层缓存的函数越多，代码风格极其不自然</em></li><li><em>如果函数依赖于局部变量，缓存的方式异常麻烦甚至于无法解决</em></li></ul><p>这里我们有必要再进行一些科普工作。 React组件可以接受函数作为prop，一般我们传递的时候有三种方式：</p><ol><li>在组件当前作用域定义局部变量</li><li>在最外层的作用域定义全局变量</li><li>作为组件自身的实例方法定义</li></ol><p>第一种方式写法最自然，但是危害最大，因为函数引用在父组件render的时候会一直变化。 第二种方式写法最蛋疼，函数引用不会变化，但是可以解决一些问题。<br>第三种方式则是前两种方法的一个比较完美结合。</p><p>至此，第一个原因提及的问题通过第三种方式可以解决。至于代码风格问题，因人而异。<br>第二个原因提到的问题可能描述的不太详细，以致于会有人疑惑：</p><ul><li>为什么不把依赖的变量作为prop一同传入给子组件，这样反而更符合React的思想</li></ul><p>传还是不传，怎么做才是最佳实践？且往下看。</p><h2 id="应该使用EventEmitter吗？"><a href="#应该使用EventEmitter吗？" class="headerlink" title="应该使用EventEmitter吗？"></a>应该使用EventEmitter吗？</h2><p>依赖是否需要作为props传递给子组件？这个我只能无奈地说要结合实际需求决定。<br>当我们不使用EventEmitter的时候，看看我们怎么处理下面三个比较复杂的场景：</p><p><strong>_场景一</strong><em> </em>假设多个父组件引用了同一子组件，父组件的依赖又各不相同，这种方式需要将依赖全部加入到子组件的props里，必然引起子组件props爆炸。_<br><em>props爆炸带来的就是一堆无谓的propType约束定义以及执行时的非空判断，代码臭味非常明显。</em><br><em>倘若子组件未来再增加一些函数类型的props，这种方式简直就是灾难！</em><br>而EventEmitter只需要给子组件绑定所需的事件交给子组件自己在合适的时机触发就可以了。</p><p><strong>_场景二</strong>_<br>少数情况我们要考虑事件解绑，而置空函数类型的props必然导致rerender。<br>当然你也可以通过设置开关变量来解决，但原本简单的逻辑变得更复杂了。<br>如果函数类型的props很多，开关变量的数目也不会少，徒增很多无意义的代码。<br>而EventEmitter只需要简单的解绑事件，也不会引起rerender。</p><p><strong>_场景三</strong>_<br>在场景一的情况下，假设现在需要把子组件的事件处理结果同步到父组件的上级。<br>在我们重构代码的时候，这种方式需要修改所有的父组件的代码才能满足需求。<br>而EventEmitter只需要在最外层的组件给子组件绑定一个事件即可。</p><p>更多的例子我就不一一列举了，相信真实世界的案例会更加多变和复杂。不过我们基本可以看出，场景越复杂EventEmitter的优势越明显。<br>EventEmitter能够将组件之间的依赖层层解耦，从而能够从容的应对需求的不断变化。</p><h2 id="什么情况下不应该使用EventEmitter？"><a href="#什么情况下不应该使用EventEmitter？" class="headerlink" title="什么情况下不应该使用EventEmitter？"></a>什么情况下不应该使用EventEmitter？</h2><p>首先我们必须承认，在开源的React组件中，使用EventEmitter非常少见。<br>为什么呢？我个人认为主要是以下几个原因：</p><ul><li>浏览器不像Node.js，没有原生的EventEmitter实现，需要引入额外的库来支持；</li><li>开源组件一般功能和需求规划较为明确，变化相对较少，使用EventEmitter收益非常有限。</li></ul><p>所以我推荐在功能通用或逻辑相对简单的组件中不必使用EventEmitter，而在功能复杂需求变化频繁的业务组件中优先使用EventEmitter。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;p&gt;之前重构项目后根据个人实战经验写了一篇&lt;a href=&quot;http://zhuanlan.zhihu.com/reduixs/20554654&quot; tar
      
    
    </summary>
    
    
      <category term="React" scheme="http://yoursite.com/tags/React/"/>
    
  </entry>
  
  <entry>
    <title>Redux三分钟入门</title>
    <link href="http://yoursite.com/2016/02/21/redux/"/>
    <id>http://yoursite.com/2016/02/21/redux/</id>
    <published>2016-02-20T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><h1 id="Redux三分钟入门"><a href="#Redux三分钟入门" class="headerlink" title="Redux三分钟入门"></a>Redux三分钟入门</h1><h2 id="什么是Redux？"><a href="#什么是Redux？" class="headerlink" title="什么是Redux？"></a>什么是Redux？</h2><p>对于前端页面，从数据层面来说，无非就是一系列的状态组合。<br>在传统的前端开发中，尤其是jQuery横行的年代，状态管理相关的理念一直没有什么起色。<br>自Flux横空出世以来，各种解决方案层出不穷，百花齐放，Redux也是在这种环境下诞生的。<br>如何描述Redux呢？<br>简而言之，它就是一个状态容器，里面存储了整个应用的所有状态。</p><blockquote><p>Redux的核心思想就是要提供<strong>_可预测</strong>_的状态管理，这对日益膨胀的大型应用来说尤其重要。</p></blockquote><p>原谅我有一点标题党，因为对于从来没有听说过Redux的人来说，三分钟入门可能真的不够。</p><h2 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h2><p>Redux中有三个基本概念非常重要：store / reducer / action。<br>Store顾名思义就是状态容器，Redux使用<strong>_createStore</strong>_这个API来创建一个全局的状态容器。这里有一点比较重要的就是：</p><blockquote><p>Redux应用只能有一个单一的Store</p></blockquote><p>我们暂时不用深究Redux为何如此设计。<br>Reducer是一个纯函数，它的职责就是用来更新状态容器中的状态，<strong>_这也是Redux中更新状态的唯一途径</strong>_。<br>Action是一个普通JavaScript对象，它是把数据从应用传递到状态容器的载体。<br>将action传递到store中很简单，使用store.dispatch(action)就可以了。</p><blockquote><p>为了区分不同的数据来源，我们一般约定每个action都必须要有一个type字段。</p></blockquote><p>这样我们的reducer函数就能根据这个type字段来决定如何修改状态容器。<br>掌握了上面的一些基本概念以后，我们就可以进入正题了，先上一段代码：</p><h2 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Redux的两个核心API</span><br><span class="line"> * createStore用于创建状态容器</span><br><span class="line"> * combineReducers用于将多个reducers合并成一个Reducer</span><br><span class="line"> */</span><br><span class="line">let &#123;createStore, combineReducers&#125; = Redux</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 状态容器的初始状态</span><br><span class="line"> * 一般用于同构应用，服务器端返回相关数据</span><br><span class="line"> */</span><br><span class="line">let INITIAL_STATE = &#123;</span><br><span class="line">  counter: &#123;</span><br><span class="line">    count: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * reducer函数，用于变更状态容器中的状态</span><br><span class="line"> * 如果action未知，则原样返回</span><br><span class="line"> * 永远不要修改state，返回一个全新的state</span><br><span class="line"> */</span><br><span class="line">function counter(state = INITIAL_STATE.counter, action) &#123;</span><br><span class="line">  switch (action.type) &#123;</span><br><span class="line">    case &apos;INCREMENT&apos;:</span><br><span class="line">      return &#123;count: state.count + 1&#125;</span><br><span class="line">    case &apos;DECREMENT&apos;:</span><br><span class="line">      return &#123;count: state.count - 1&#125;</span><br><span class="line">    default:</span><br><span class="line">      return state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 状态容器三个核心方法：</span><br><span class="line"> * subscribe用于监听事件，每当dispatch的时候会执行</span><br><span class="line"> * dispatch用于分发action，这是改变状态容器中state的唯一途径</span><br><span class="line"> * getState获取当前state</span><br><span class="line"> */</span><br><span class="line">let store = createStore(combineReducers(&#123;counter&#125;), INITIAL_STATE)</span><br><span class="line"></span><br><span class="line">store.subscribe(() =&gt;</span><br><span class="line">  console.log(&apos;获取当前状态容器：&apos;, store.getState())</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">store.dispatch(&#123; type: &apos;INCREMENT&apos; &#125;) // count = 1</span><br><span class="line">store.dispatch(&#123; type: &apos;DECREMENT&apos; &#125;) // count = 0</span><br></pre></td></tr></table></figure><p><a href="http://codepen.io/simongfxu/pen/eJLwMb?editors=0012" target="_blank" rel="noopener">在线查看DEMO</a><br>上面的DEMO代码逻辑大致如下：</p><ol><li>先定义reducer</li><li>调用createStore创建store</li><li>最后dispatch相关的action</li></ol><p>对应到具体业务中的过程可能是这样：</p><ol><li>用户点击某个按钮</li><li>然后状态容器dispatch这个action</li><li>action最后传达到reducer中</li><li>reducer根据action的内容来修改状态</li><li>状态容器状态发生改变后触发视图更新</li></ol><p>理解了上面的DEMO代码之后，Redux基本上就算入门啦！</p><h2 id="后续深入"><a href="#后续深入" class="headerlink" title="后续深入"></a>后续深入</h2><p>学习完上面的DEMO后，推荐你先看下Redux的一些<a href="http://camsong.github.io/redux-in-chinese/docs/introduction/ThreePrinciples.html" target="_blank" rel="noopener">基本理念</a>，了解Redux背后设计的前因后果，然后再针对性地围绕<a href="http://camsong.github.io/redux-in-chinese/index.html" target="_blank" rel="noopener">Redux官网中文版</a>学习（个人不太推荐从头到尾的精读，时间充裕的话请自便）。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;h1 id=&quot;Redux三分钟入门&quot;&gt;&lt;a href=&quot;#Redux三分钟入门&quot; class=&quot;headerlink&quot; title=&quot;Redux三分钟入门
      
    
    </summary>
    
    
      <category term="Redux" scheme="http://yoursite.com/tags/Redux/"/>
    
  </entry>
  
  <entry>
    <title>Better React</title>
    <link href="http://yoursite.com/2016/02/04/better-react/"/>
    <id>http://yoursite.com/2016/02/04/better-react/</id>
    <published>2016-02-03T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><h1 id="Better-React"><a href="#Better-React" class="headerlink" title="Better React"></a>Better React</h1><p>使用Ractive（一个MVVM框架）编写组件的时候，我就经常想获取用户当前传入的attributes。<br>很无奈，Ractive并不支持此功能。为此我还专门提过一个<a href="https://github.com/ractivejs/ractive/issues/2059" target="_blank" rel="noopener">issue</a>。<br>React开始流行的时候，作为MVVM的爱好者我其实是比较抵触的。<br>后来发现势头不太对，感觉还是有必要了解下。<br>于是就抱着试一试的心理，开始了React的学习历程。<br>依稀记得当我首次接触props和state这对兄弟的时候，我的内心是十分激动的。</p><p>随着React学习的愈发深入，就愈发觉得掌握props和state的使用，对于掌握React整个基础体系是有多么重要。<br>今天本文就结合我自己的开发实践，讲讲使用props的一个基本原则。当然如果有更好的实践方法，烦请多交流。</p><h2 id="一个典型"><a href="#一个典型" class="headerlink" title="一个典型"></a>一个典型</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> Component = React.createClass(&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">let</span> handleClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'click handled'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;SubComponent onClick=&#123;handleClick&#125; /&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>通常来说，子组件依赖父组件的某些变量、状态，或者需要更新父组件的UI这种需求还是很普遍的。<br>上例中父组件将一个handleClick函数作为prop传入给子组件，handleClick由于其作用域的天然优势可以将子组件的依赖问题层层化解，异常的简单方便。<br>这种将函数作为props传入子组件解决依赖问题的处理方式，也是目前React父子组件通信处理中一种非常普遍且流行的方式。</p><p>但是既然以此为例，那它肯定是反面典型了！</p><h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>下面我们以一个稍微复杂点的例子来看看这种处理方式的缺陷， <a href="http://codepen.io/simongfxu/pen/rxZBNz?editors=0010" target="_blank" rel="noopener">查看演示效果</a>。<br>试试点击演示中的Add按钮，然后查看控制台输出。</p><p>你会发现每点一次，底层的DumbCompoent的render都会触发一次。<br>照理说DumbComponent没有任何的props的变更应该不会rerender，为什么呢？<br>因为SmartComponent中传递prop的时候传递的是一个匿名函数，<br>DumbComponent在shouldComponentUpdate判断的时候由于onClick的引用不同而返回true。</p><p>如何修复呢？<br>很自然的你可能会想到将onClick这个函数缓存起来，这样引用就不会一直变了。<br>仔细思考一番其实这个方式并不可取，主要是因为：</p><blockquote><ul><li>类似的prop越多，外层缓存的函数越多，代码风格极其不自然</li><li>如果prop依赖于局部变量，缓存的方式异常麻烦甚至于无法解决<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2></li></ul></blockquote><p>避免将函数作为props传递，使用EventEmitter来对父子组件的依赖解耦。</p><p>如果不了解EventEmitter，可以看看这篇<a href="http://www.html-js.com/article/1649" target="_blank" rel="noopener">文章</a>。<br>浏览器端的实现我推荐<a href="https://github.com/primus/eventemitter3" target="_blank" rel="noopener">EventEmitter3</a>。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>为了避免不必要的麻烦，请不要将函数传入props中，取而代之使用EventEmitter。<br>遵循此原则，props始终传递基本类型或者只包含基本类型的对象。<br>在今后的React学习之路上，当你了解<a href="https://github.com/camsong/blog/issues/3" target="_blank" rel="noopener">ImmutableJS</a>时，这个原则将会让你深深受益。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;h1 id=&quot;Better-React&quot;&gt;&lt;a href=&quot;#Better-React&quot; class=&quot;headerlink&quot; title=&quot;Better
      
    
    </summary>
    
    
      <category term="React" scheme="http://yoursite.com/tags/React/"/>
    
  </entry>
  
  <entry>
    <title>【读书笔记】持续集成（软件质量改进和风险降低之道）之二</title>
    <link href="http://yoursite.com/2015/12/17/ci-2/"/>
    <id>http://yoursite.com/2015/12/17/ci-2/</id>
    <published>2015-12-16T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><h1 id="持续集成（软件质量改进和风险降低之道）"><a href="#持续集成（软件质量改进和风险降低之道）" class="headerlink" title="持续集成（软件质量改进和风险降低之道）"></a>持续集成（软件质量改进和风险降低之道）</h1><h2 id="第三章-利用CI减少风险"><a href="#第三章-利用CI减少风险" class="headerlink" title="第三章 利用CI减少风险"></a>第三章 利用CI减少风险</h2><p><em>品质意味着在没人看的时候也把事情做对。 by 亨利 福特</em></p><ul><li>我们的任务进度怎么样了？请查看最后一次构建</li><li>测试覆盖率达到多少？请查看最后一次构建</li><li>谁最后签入了代码？请查看最后一次构建</li></ul><p>利用CI，对每次变更建立一张“品质安全网”，更快地交付软件产品。当你在每次变更时按下“集成按钮”时，你就为尽早发现风险、经常发现风险奠定了基础。</p><p><strong>3.1 风险：没有可部署的软件</strong></p><p>场景：“在我的机器上是可行的”<br>解决方案：消除IDE与构建过程的耦合，使用自动化构建脚本</p><p>场景：与数据库同步（害怕修改或重构数据库和源代码、很难用不同的测试数据填充数据库、很难维护开发和测试环境）<br>解决方案：将数据库相关融入到开发过程中，对数据库进行审查和测试</p><p><strong>3.2 风险：很晚才发现缺陷</strong></p><p>场景：对错误的修复导致了其它无关的错误浮现出来。我们对变更没有信心，因为我们不知道变更对其它部分的影响。<br>解决方案：为变更的代码编写单元测试。</p><p><strong>3.3 风险：缺少项目可见性</strong></p><p>场景：没有工具显示整个项目的总体设计情况，没有类和关系的模型。<br>解决方案：使用自动化文档生成工具。</p><p><strong>3.4 风险：低品质的软件</strong></p><p>场景：坚持编码标准<br>场景：维持架构标准<br>场景：重复的代码<br>解决方案：使用相关的开发工具:Checkstyle / PMD / jDepend / Simian</p><h2 id="第四章-针对每次变更构建软件"><a href="#第四章-针对每次变更构建软件" class="headerlink" title="第四章 针对每次变更构建软件"></a>第四章 针对每次变更构建软件</h2><p><em>整个该死的宇宙必须被分解为一小块一小块，然后重新构造。 by 亨利 米勒</em></p><p>有时候开发者就像鞋匠，为他的所有客户提供了鞋子，却忘记为他自己的孩子做鞋。</p><p><strong>4.1 自动化构建</strong></p><p>要记住，构建应该是按一下按钮的事。</p><p><strong>4.2 执行单命令构建</strong></p><p>构建脚本的逻辑过程：</p><ol><li>清理</li><li>编译</li><li>集成数据库</li><li>测试</li><li>审查</li><li>部署</li></ol><p><strong>4.3 将构建脚本从IDE分离</strong></p><p>无</p><p><strong>4.4 集中放置软件资产</strong></p><p>使用版本库来存放所有文件。</p><p><strong>4.5 创建一致的目录结构</strong></p><p>基于软件开发过程中的活动创建一致的、有逻辑的目录结构。<br>构建过程中只需取出包含这个任务所需的源码和相关脚本，而不是所有的东西。</p><p><strong>4.6 让构建快速失败</strong></p><p>越有可能失败的的任务，应该越早在构建脚本中执行。</p><p><strong>4.7 针对所有环境构建</strong></p><p>改进构建脚本的可配置项，将构建脚本参数化。</p><p><strong>4.8 构建的类型和触发机制</strong></p><p>三个层次：个人、团队、客户。分别对应私有构建、集成构建、发布构建。<br>触发机制：手工、定期执行、轮询变更、事件驱动。</p><p><strong>4.9 使用专门的集成构建计算机</strong></p><p>无</p><p><strong>4.10 使用CI服务器</strong></p><p>典型的CI服务器包含如下功能：</p><ul><li>以特定的时间间隔轮询版本库变更</li><li>定期执行某种操作</li><li>标识出安静期，在这段时间内部进行集成构建</li><li>支持不同的构建脚本</li><li>向相关人员发送电子邮件</li><li>显示构建历史</li><li>信息面板查看集成构建的信息</li><li>为不同的项目支持多个版本控制系统</li></ul><p><strong>4.11 执行手工集成构建</strong></p><p>使用手工集成构建不能保证坚持持续集成的实践。不利于提高品质的、更小、更频繁的集成。</p><p><strong>4.12 执行快速构建</strong></p><p>保持构建不超过10分钟；收集、分析构建测量数据；改进测试性能。</p><p><strong>4.13 分阶段构建</strong></p><p>减少构建时间的一种方式。先执行轻量级构建并对软件进行单元测试，然后执行重量级构建。</p><p><strong>4.14 这对您如何生效</strong></p><p><em>我的项目有七十亿行代码，怎么可能用这种方式？</em></p><p>大项目主要考虑让构建保持迅速，定期执行而不是持续执行。将代码分解为独立的子项目。</p><p><em>我们的软件太复杂了。我们 必须手工做一些事 或 “我们一切进行的的很好”</em></p><p>这正是创建CI系统的理由，因为你可能在执行重复过程上花了很多时间。如果软件复杂，有很多依赖，那么持续集成就更有必要，需要创建一个系统将所有的部件组装在一起，执行测试和审查，确保所有部分运行正常。<br>当然，这并不是说创建一个可重复的构建过程会很容易。将过程分解，而不是一次加入所有CI包含的东西。</p><p>还有一点：CI是针对主线执行，分支必须在适当的时候合并到主线。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;h1 id=&quot;持续集成（软件质量改进和风险降低之道）&quot;&gt;&lt;a href=&quot;#持续集成（软件质量改进和风险降低之道）&quot; class=&quot;headerlink&quot;
      
    
    </summary>
    
    
      <category term="持续集成" scheme="http://yoursite.com/tags/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/"/>
    
  </entry>
  
  <entry>
    <title>【读书笔记】持续集成（软件质量改进和风险降低之道）之一</title>
    <link href="http://yoursite.com/2015/12/10/ci-1/"/>
    <id>http://yoursite.com/2015/12/10/ci-1/</id>
    <published>2015-12-09T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><h1 id="持续集成（软件质量改进和风险降低之道）"><a href="#持续集成（软件质量改进和风险降低之道）" class="headerlink" title="持续集成（软件质量改进和风险降低之道）"></a>持续集成（软件质量改进和风险降低之道）</h1><h2 id="第一章-启程"><a href="#第一章-启程" class="headerlink" title="第一章 启程"></a>第一章 启程</h2><p><em>每天吃一个苹果和实际去做是两码事。 by Kathy Sierra</em></p><p><strong>1.1 针对每次变更构建软件</strong></p><p><em>一次构建不止是一次编译。它可能包含编译、测试、代码审查和部署以及其它一些事情。一次构建是将源代码放在一起，并验证软件可以作为一个一致的单元运行的过程。</em></p><p>CI场景中的步骤通常是这样的：</p><ol><li>开发者提交代码到版本控制库，CI服务器轮询检查代码变更；</li><li>CI服务器取出最新的源代码执行构建脚本，对软件进行集成；</li><li>CI服务器向指定的成员发出电子邮件，提供构建结果的反馈信息；</li><li>CI服务器继续轮询检查代码变更。</li></ol><p>通过一次构建，开发团队可以回答以下问题：</p><ul><li>软件组成部分是否能协同工作？</li><li>代码复杂度如何？</li><li>是否坚持了制定的编码标准？</li><li>自动测试覆盖了多少代码？</li><li>是否成功的通过了所有测试？</li><li>应用程序是否满足性能要求？</li><li>最近的开发是否存在问题</li></ul><p>你之所以希望“持续”地构建，就是为了得到快速的反馈。这样能在开发生命周期找到并修正问题。</p><p><strong>1.2 CI的特征</strong></p><p>CI需要具备的特征</p><ul><li>与版本控制库连接</li><li>构建脚本</li><li>某种类型的反馈机制（通常是邮件）</li><li>集成源代码变更的过程（CI服务器）</li></ul><p>CI的子过程：</p><ul><li>源代码编译</li><li>数据库集成</li><li>测试 <em>（没有自动化的、持续的测试的CI不能算是CI）</em></li><li>审查 <em>（自动化代码审查通过强制遵守规则来增加软件品质）</em></li><li>部署 <em>（任何时候都可以拿出能工作、可部署的软件）</em></li><li>文档与反馈</li></ul><p>一个好的CI系统的关键特征就是“速度”。CI系统的本质是及时向开发者和项目风险承担着提供反馈信息。</p><h2 id="第二章-引入持续集成"><a href="#第二章-引入持续集成" class="headerlink" title="第二章 引入持续集成"></a>第二章 引入持续集成</h2><p><em>假定是所有麻烦之母</em></p><ul><li>假定一个方法会得到正确的调用参数</li><li>假定开发者会坚持编码标准</li><li>假定配置文件不会被覆盖或者修改</li></ul><p>持续集成在每次版本控制系统发生变化时就执行构建，这有助于减少项目中的假定。<br>CI是一些基本实践。它不是软件开发中最炫目的工作，不会有用户说“哇，我真的喜欢你们上一个版本的集成方式”。它是软件开发的幕后工作，只有使用过CI的人才能体会到一致的、可重复的构建过程所带来的好处。</p><p>检查软件的品质就是检查最新的集成构建，就这么简单！</p><p><strong>2.1 CI生活中的一天</strong></p><p>无</p><p><strong>2.2 CI的价值是什么</strong></p><ul><li>减少风险</li><li>减少重复过程</li><li>在任何时间地点生成可部署的软件</li><li>增强项目的可见性</li><li>对开发团队的软件建立起更强大的产品信心</li></ul><p>减少风险</p><ul><li>缺陷的检测和修复变得更快</li><li>软件的健康程度可以测量</li><li>减少假定</li></ul><p>增强项目的可见性</p><ul><li>对当前构建状态和品质指标提供及时的信息</li><li>观察到一些项目相关的趋势</li></ul><p>建立更强大的产品信心</p><ul><li>如果没有频繁的集成，团队成员会感到压抑，因为他不知道代码的修改所造成的影响。比如罚款！</li></ul><p><strong>2.3 什么阻碍了团队使用CI</strong></p><ul><li>增加了维护CI系统的开销（项目太复杂、额外工作太多）</li><li>变化太大（增量实现，从日构建开始）</li><li>失败的构建太多</li><li>额外的硬件/软件成本</li></ul><p><strong>2.4 如何进行持续集成</strong></p><ul><li>确定：确定需要自动化的过程（编译、审查、测试、部署、数据库集成）</li><li>构建：创建构建脚本</li><li>分享：利用版本控制库让其它人用起来</li><li>持续：在变更之后执行自动化的过程</li></ul><p><strong>2.5 项目应该再何时以何种方式实现CI</strong></p><ul><li>越早越好，越晚越拒绝改变。</li><li>CI最终希望是在每次代码库变更时就执行构建，但是也可以从每日构建开始。</li><li>早起可以不加入某些功能，比如自动化的回归测试</li></ul><p><strong>2.6 集成的演进</strong></p><p>它不是突然冒出来的软件开发方法，是集成软件演进的成功。</p><p><strong>2.7 如何与其它开发实践配合</strong></p><ul><li>单元测试</li><li>编码标准</li><li>重构</li><li>小发行版本</li><li>共同拥有代码，避免知识孤岛</li></ul><p><strong>2.8 CI需要多少时间架设</strong></p><p><strong>2.9 CI与您</strong></p><p>七项最佳实践：</p><ul><li>经常提交代码（每天至少一次）</li><li>不要提交无法构建的代码（不能编译、无法通过测试、代码审查失败）</li><li>立即修复无法构建的代码（优先级最高）</li><li>编写自动化的单元测试</li><li>必须通过所有测试和审查（不是90%或者99%，而是100%）</li><li>执行私有构建（先在本地构建成功）</li><li>避免签出无法构建的代码（等待新的变更或者帮助修复无法集成的构建）</li></ul><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;h1 id=&quot;持续集成（软件质量改进和风险降低之道）&quot;&gt;&lt;a href=&quot;#持续集成（软件质量改进和风险降低之道）&quot; class=&quot;headerlink&quot;
      
    
    </summary>
    
    
      <category term="持续集成" scheme="http://yoursite.com/tags/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/"/>
    
  </entry>
  
  <entry>
    <title>捉虫记之decodeURIComponent</title>
    <link href="http://yoursite.com/2015/06/30/decodeURIComponent/"/>
    <id>http://yoursite.com/2015/06/30/decodeURIComponent/</id>
    <published>2015-06-29T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><p>DataEye游戏分析平台有个实时日志功能，用于展示接收来自游戏客户端SDK上报数据以及游戏开发商使用HTTP接口发送的数据。</p><h2 id="第一版"><a href="#第一版" class="headerlink" title="第一版"></a>第一版</h2><p>数据库收到什么样的JSON数据就直接返回给前端展示，终于有一天客户反馈页面脚本报错。</p><p>一番调查，原来是数据库中存在特殊字符，于是要求后台全部url encode一次，前端decode就可以了。验证OK，于是测试发布。直到有一天用户反馈部分数据没有decode，还是类似%25XX的字符。</p><h2 id="第二版"><a href="#第二版" class="headerlink" title="第二版"></a>第二版</h2><p>一番调查，原来是用户使用的是HTTP接口发送数据而不是SDK，所以部分数据自己encode了一次。然后服务器返回给前端页面的就是encode两次的数据。</p><p>不就encode两次的问题嘛，页面decode两次就可以了嘛！于是无脑地吧decodeURIComponent(str)全部替换成了decodeURIComponent(decodeURIComponent(str))，发现问题居然解决了，找了另外的客户数据测试了下，验证也OK，于是发布。直到有一天某个另外的客户反馈页面脚本报错。</p><h2 id="第三版"><a href="#第三版" class="headerlink" title="第三版"></a>第三版</h2><p>一番调查，根据URI Malformed Error这个罪证google得知，原来是源字符串不是合法的URL编码的字符串。虽然提示已经相当的明确了，但由于JSON数据量不少，字段较多，而且有些地方只需要decode一次，有些地方又需要decode两次，定位问题还是花了一些时间。最后发现罪魁祸首居然是用户输入的内容<code>14%</code>。</p><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safeDecodeURIComponent</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!str || <span class="keyword">typeof</span> str !== <span class="string">'string'</span>) <span class="keyword">return</span> <span class="built_in">String</span>(str)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// encodeURIComponent不编码字符有71个：!， '，(，)，*，-，.，_，~，0-9，a-z，A-Z</span></span><br><span class="line">    <span class="keyword">var</span> twiceEncodedReg = <span class="regexp">/^(%\w&#123;4,4&#125;|[!'()*\-._~0-9a-z])+$/gi</span></span><br><span class="line">    <span class="keyword">var</span> encodedReg = <span class="regexp">/^(%\w&#123;2,2&#125;|[!'()*\-._~0-9a-z])+$/gi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里用try catch是因为即使正则匹配也有可能解码异常，异常或者不匹配时返回源字符串即可</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (twiceEncodedReg.test(str)) <span class="keyword">return</span> <span class="built_in">decodeURIComponent</span>(<span class="built_in">decodeURIComponent</span>(str))</span><br><span class="line">        <span class="keyword">if</span> (encodedReg.test(str)) <span class="keyword">return</span> <span class="built_in">decodeURIComponent</span>(str)</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> str</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><blockquote><ul><li><a href="http://xkr.us/articles/javascript/encode-compare/" target="_blank" rel="noopener">Comparing escape(), encodeURI(), and encodeURIComponent()</a></li><li><a href="http://www.cnblogs.com/jhxk/articles/1634359.html" target="_blank" rel="noopener">http://www.cnblogs.com/jhxk/articles/1634359.html</a><h2 id="最后的总结"><a href="#最后的总结" class="headerlink" title="最后的总结"></a>最后的总结</h2></li></ul></blockquote><p>基础知识不扎实导致无法深入剖析问题所在，解决方案自以为然也就不足为怪了。</p><p>—-7-21更新—-</p><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>果然还是有后续！昨天突然一个客户又反馈有乱码，一番研究发现用户输入部分编码，部分未编码。上面的方法就不凑效了，于是花了几分钟做了如下改进：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safeDecodeURIComponent</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> lastResult = str, current</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>((current = <span class="built_in">decodeURIComponent</span>(lastResult)) != lastResult) &#123;</span><br><span class="line">            lastResult = current</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lastResult</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;p&gt;DataEye游戏分析平台有个实时日志功能，用于展示接收来自游戏客户端SDK上报数据以及游戏开发商使用HTTP接口发送的数据。&lt;/p&gt;&lt;h2 id=&quot;
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>白鹭引擎无废话快速上手</title>
    <link href="http://yoursite.com/2015/05/03/%E7%99%BD%E9%B9%AD%E5%BC%95%E6%93%8E%E6%97%A0%E5%BA%9F%E8%AF%9D%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/"/>
    <id>http://yoursite.com/2015/05/03/白鹭引擎无废话快速上手/</id>
    <published>2015-05-02T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><p>如果你从未听说白鹭引擎，也不了解其用途，那么本文可能并不适合你。阅读之前请确保你已了解白鹭引擎是一套基于<code>TypeScript</code>的游戏开发引擎，本文讲述了使用白鹭引擎开发HTML5项目的一般流程。</p><h2 id="安装白鹭引擎"><a href="#安装白鹭引擎" class="headerlink" title="安装白鹭引擎"></a>安装白鹭引擎</h2><p>安装很简单，不论是windows还是mac，前往官网下载白鹭引擎的安装包，解压安装即可。参考链接：</p><blockquote><ul><li><a href="http://docs.egret-labs.org/post/quitestart/install/installwin.html" target="_blank" rel="noopener">Windows</a></li><li><a href="http://docs.egret-labs.org/post/quitestart/install/instalformac.html" target="_blank" rel="noopener">Mac</a></li></ul></blockquote><p>友情提示：至本教程完成时，白鹭引擎尚未提供适用于Linux系统的安装包。</p><h2 id="验证安装过程"><a href="#验证安装过程" class="headerlink" title="验证安装过程"></a>验证安装过程</h2><p>安装完成之后，打开终端输入<code>egret</code>，命令行会展示用法提示以及command列表。</p><p>如果egret命令未找到，说明你的安装过程出错了。</p><p>白鹭引擎的命令行工具是基于<code>Node.js</code>开发的，其源代码也是开源的。如果对某个命令有疑问或者对其实现感兴趣，可以直接查看其源代码更为方便。具体位置在白鹭引擎安装路径下的<code>/egret/tools/lib/tools</code>，比如<code>build.js</code>和<code>publish.js</code>分别对应<code>egret build</code>和<code>egret publish</code>命令。或者前往GitHub查看<a href="https://github.com/egret-labs/egret-core/tree/master/tools/lib/tools" target="_blank" rel="noopener">https://github.com/egret-labs/egret-core/tree/master/tools/lib/tools</a></p><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">egret create HelloWorld</span><br></pre></td></tr></table></figure><h2 id="编译项目"><a href="#编译项目" class="headerlink" title="编译项目"></a>编译项目</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">egret build HelloWorld</span><br></pre></td></tr></table></figure><p>将TypeScript的源代码编译为原生JavaScript代码，默认编译为HTML5项目。<strong>如果需要编译为native项目</strong>，则加上<code>--runtime native</code>参数。</p><h2 id="运行项目"><a href="#运行项目" class="headerlink" title="运行项目"></a>运行项目</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">egret startserver HelloWorld</span><br></pre></td></tr></table></figure><p>白鹭引擎内部创建了一个基于Express的WebServer，当运行此命令后会自动在默认刘传奇中打开项目首页。</p><h2 id="发布项目"><a href="#发布项目" class="headerlink" title="发布项目"></a>发布项目</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">egret publish HelloWorld</span><br></pre></td></tr></table></figure><h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><p>HelloWorld之后继续深入，请阅读<a href="http://docs.egret-labs.org/post/quitestart/helloworld/helloworld2.html" target="_blank" rel="noopener">http://docs.egret-labs.org/post/quitestart/helloworld/helloworld2.html</a>。</p><p>白鹭引擎相关开源项目：<a href="https://github.com/egret-labs" target="_blank" rel="noopener">https://github.com/egret-labs</a></p><h2 id="关于TypeScript"><a href="#关于TypeScript" class="headerlink" title="关于TypeScript"></a>关于TypeScript</h2><p>如果读者需要使用白鹭引擎开发游戏，那么系统地学习TypeScript是必经之路。虽然TypeScript的入门门槛不算高，但是完全掌握也需不少时间，不过对于开发一款游戏来说，掌握这门语言带来的收益应该远远大于学习的成本。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;p&gt;如果你从未听说白鹭引擎，也不了解其用途，那么本文可能并不适合你。阅读之前请确保你已了解白鹭引擎是一套基于&lt;code&gt;TypeScript&lt;/code&gt;
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>RequireJS定义模块常用的两种方式</title>
    <link href="http://yoursite.com/2015/04/09/requirejs%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9D%97%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F/"/>
    <id>http://yoursite.com/2015/04/09/requirejs定义模块的两种方式/</id>
    <published>2015-04-08T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><p>RequieJS是一个遵循AMD规范的模块加载器，其定义模块的方式非常简洁，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(id?, dependencies?, factory);</span><br></pre></td></tr></table></figure><blockquote><ul><li>id为模块名称，字符串，可选参数</li><li>dependencies为本模块依赖的其它模块，数组，可选</li><li>factory为模块的实现，可以为一个对象或者函数，必填</li></ul></blockquote><p>最常见的定义模块的方式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">define([&apos;jquery&apos;], function($)&#123;</span><br><span class="line">    var myModule = &#123;</span><br><span class="line">        add: function(a, b) &#123;</span><br><span class="line">               return a + b</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * 这里将对象直接返回即可</span><br><span class="line">     * 返回函数也是可以的</span><br><span class="line">     * 如果没有任何返回值，那么模块作为依赖被引入的时候就是undefined</span><br><span class="line">     */</span><br><span class="line">    return myModule</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>另外还有一种类似CommonJS的方式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">define([&apos;exports&apos;], function(exports)&#123;</span><br><span class="line">    exports.add =  function(a, b) &#123;</span><br><span class="line">        return a + b</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>这种方式将CommonJS模块的转换为AMD风格的模块十分方便。</p><p>如果一个模块同时兼容AMD、CommonJS或者无模块系统的传统页面，那么就需要用到<a href="https://github.com/umdjs/umd/blob/master/returnExports.js" target="_blank" rel="noopener">UMD</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// root在浏览器里代表window对象，node里面则是global</span><br><span class="line">;(function (root, factory) &#123;</span><br><span class="line">    // AMD</span><br><span class="line">    if (typeof define === &apos;function&apos; &amp;&amp; define.amd) &#123;</span><br><span class="line">        define([], factory)</span><br><span class="line">    &#125; else if (typeof exports === &apos;object&apos;) &#123;</span><br><span class="line">        // CommonJS</span><br><span class="line">        module.exports = factory()</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // 暴露出的全局变量</span><br><span class="line">        root.moduleName = factory()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;(this, function () &#123;</span><br><span class="line">    var myModule = &#123;&#125;</span><br><span class="line">    return myModule</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure><p>参考文档</p><hr><blockquote><ul><li><a href="http://segmentfault.com/a/1190000000761330" target="_blank" rel="noopener">AMD模块定义规范</a></li><li><a href="http://www.cnblogs.com/snandy/archive/2012/03/12/2390782.html" target="_blank" rel="noopener">AMD：浏览器中的模块规范</a></li></ul></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;p&gt;RequieJS是一个遵循AMD规范的模块加载器，其定义模块的方式非常简洁，如下：&lt;/p&gt;&lt;figure class=&quot;highlight plain
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>美妙的函数之isArguments</title>
    <link href="http://yoursite.com/2015/04/02/isArguments/"/>
    <id>http://yoursite.com/2015/04/02/isArguments/</id>
    <published>2015-04-01T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><p>判断变量是否为Arguments对象没有想象中的那么简单，你可能会使用下面这种方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object.prototype.toString.call(value) === &apos;[Object Arguments]&apos;</span><br></pre></td></tr></table></figure><p>我们先来看看著名的es5-shim是如何实现的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var _toString = ObjectPrototype.toString;</span><br><span class="line"></span><br><span class="line">var isFunction = function(val) &#123;</span><br><span class="line">    return ObjectPrototype.toString.call(val) === &apos;[object Function]&apos;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var isArguments = function isArguments(value) &#123;</span><br><span class="line">    var str = _toString.call(value);</span><br><span class="line">    var isArgs = str === &apos;[object Arguments]&apos;;</span><br><span class="line">    if (!isArgs) &#123;</span><br><span class="line">        isArgs = !isArray(value) &amp;&amp; value !== null &amp;&amp; typeof value === &apos;object&apos; &amp;&amp; typeof value.length === &apos;number&apos; &amp;&amp; value.length &gt;= 0 &amp;&amp; isFunction(value.callee);</span><br><span class="line">    &#125;</span><br><span class="line">    return isArgs;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>因为某些浏览器的<a href="https://github.com/lodash/lodash/blob/master/lodash.src.js#L1004" target="_blank" rel="noopener">buggy</a>行为，这个方法不得不这么长。再看看<a href="https://github.com/lodash/lodash/blob/master/lodash.src.js#L8480" target="_blank" rel="noopener">lodash</a>的实现：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">var MAX_SAFE_INTEGER = Math.pow(2, 53) - 1;</span><br><span class="line"></span><br><span class="line">function isObjectLike(value) &#123;</span><br><span class="line">    return !!value &amp;&amp; typeof value == &apos;object&apos;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function isLength(value) &#123;</span><br><span class="line">  return typeof value == &apos;number&apos; &amp;&amp; value &gt; -1 &amp;&amp; value % 1 == 0 &amp;&amp; value &lt;= MAX_SAFE_INTEGER;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function isArguments(value) &#123;</span><br><span class="line">  var length = isObjectLike(value) ? value.length : undefined;</span><br><span class="line">  return isLength(length) &amp;&amp; objToString.call(value) == argsTag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Fallback for environments without a `toStringTag` for `arguments` objects.</span><br><span class="line">if (!support.argsTag) &#123;</span><br><span class="line">  isArguments = function(value) &#123;</span><br><span class="line">    var length = isObjectLike(value) ? value.length : undefined;</span><br><span class="line">    return isLength(length) &amp;&amp; hasOwnProperty.call(value, &apos;callee&apos;) &amp;&amp;</span><br><span class="line">      !propertyIsEnumerable.call(value, &apos;callee&apos;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对比两种实现，es5-shim仅仅只是做了arguments对象特有的属性检测，而lodash的实现不论是从代码可读性还是严谨方面来考察都是极其完美的。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;p&gt;判断变量是否为Arguments对象没有想象中的那么简单，你可能会使用下面这种方法：&lt;/p&gt;&lt;figure class=&quot;highlight plai
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>程序员的强迫症</title>
    <link href="http://yoursite.com/2014/07/29/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E5%BC%BA%E8%BF%AB%E7%97%87/"/>
    <id>http://yoursite.com/2014/07/29/程序员的强迫症/</id>
    <published>2014-07-28T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><p>编程追求效率，却也讲究习惯。习惯改变之难，还真不能说<code>那就不是个事儿</code>，在技术圈子尤甚。</p><p>当然，JavaScript这个圈子也不例外，比如这些：</p><ul><li><a href="http://www.zhihu.com/question/20298345" target="_blank" rel="noopener">JavaScript语句后面应该加分号吗？</a></li><li><a href="http://www.nczonline.net/blog/2013/06/25/eval-isnt-evil-just-misunderstood/" target="_blank" rel="noopener">eval is evil?</a></li><li><a href="http://javascriptweblog.wordpress.com/2011/02/07/truth-equality-and-javascript/" target="_blank" rel="noopener">== or ===?</a></li><li>…</li></ul><p>上面的话题，个个是G点，分分钟引发高潮。就犹如<code>Vim和Emacs</code>、<code>Windows和Linux</code>等话题，一旦开篇随之而来的就是引经据典、长篇大论、你死我活、百态尽出。</p><p>作为有格调的程序员，我们应追求效率。而非沉浸于无谓的争论，无端的争论往往因为恪守习惯，不善变通。</p><p>就上面的话题进行争论，或许还有些”技术主义情怀”。但是下面的这些纯感性的<strong>习惯</strong>呢？不妨先看看：</p><ul><li>缩进用tab还是用空格，你喜欢哪一种?</li><li>tab等于两个还是四个空格，你喜欢哪一种？</li><li>对象的键值是紧凑连接，还是在冒号后加一个空格，你喜欢哪一种？</li><li>变量声明，单行还是多行，你又喜欢哪一种？</li><li>单行代码块的花括号，加还是不加？</li><li>…</li></ul><p>这种<strong>习惯</strong>多如牛毛，以至“知音”着实难寻，因为实在是众口难调、各有所爱。也难怪<strong>Web Storm</strong>等编辑器在Code Style上花尽心思。</p><p>一味地拘泥于习惯，在团队协作时就会患上<strong>强迫症</strong>。比如在别人的代码后面加个分号、补个空格，多加个空白行等等诸如此类。如果赶上心情好、情绪佳，或许会再花上一两小时，与他人舌战一番，定要分个胜负。</p><p>此种行为既“无伤大雅”，也非“罪恶滔天”，情不自禁而已。不然“看着心里难受”，这种难受之于程序员，比1px的像素差之于产品经理可来的猛烈多了。于是乎加分号、补空格、按换行、删注释、调整顺序，忙得不亦乐乎。待大功告成，仿佛看见了光，解救了天解救了地也解救了自己，心情倍儿爽。</p><p>如果你还在做这种“解救众生”的活，不妨试试JSHint来换个活法儿吧。</p><h2 id="什么是JSHint"><a href="#什么是JSHint" class="headerlink" title="什么是JSHint"></a>什么是JSHint</h2><p><a href="http://www.jshint.com/about/" target="_blank" rel="noopener">JSHint</a>是一个用于检查JavaScript代码错误和潜在问题的工具。通过简单的配置，它可以强制约束团队保持一致的编码风格。</p><h2 id="JSHint配置文件的格式"><a href="#JSHint配置文件的格式" class="headerlink" title="JSHint配置文件的格式"></a>JSHint配置文件的格式</h2><p>在项目根目录新加一个名称为<strong>.jshintrc</strong>的文件，加入相关配置即可，典型的配置如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">"node"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"eqeqeq"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"forin"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"plusplus"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"undef"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"unused"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"strict"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>json文件中的每一项都对应着一条规则。如果代码违反了规则，编辑器会给出错误提示。这方面Web Storm非常不错。JSHint详细配置文档，请看<a href="http://www.jshint.com/docs/options/" target="_blank" rel="noopener">这里</a></p><p>每个文件夹可以有单独的.jshintrc，作用范围就是其下JavaScript代码。还可以使用<strong>.jshintignore</strong>来排除将规则应用到当前目录指定的文件和文件夹。</p><h2 id="如何在Web-Storm中使用JSHint"><a href="#如何在Web-Storm中使用JSHint" class="headerlink" title="如何在Web Storm中使用JSHint"></a>如何在Web Storm中使用JSHint</h2><blockquote><ul><li><code>CMD + ,</code> 打开偏好设置，输入JSHint搜索习惯配置项</li><li>选中Inspections&gt;JavaScript&gt;Code quality tools&gt;JSHint</li><li>点击JavaScript&gt;Code quality tools&gt;JSHint，勾选enable和use config file(default)即可</li></ul></blockquote><h2 id="配置详解"><a href="#配置详解" class="headerlink" title="配置详解"></a>配置详解</h2><h3 id="强制选项-enforcing-options"><a href="#强制选项-enforcing-options" class="headerlink" title="强制选项(enforcing options)"></a>强制选项(enforcing options)</h3><p>设置为true时，应用规则，对代码约束更严格。</p><table><thead><tr><th>配置项</th><th>释义</th><th>好处</th></tr></thead><tbody><tr><td>bitwise</td><td>禁止按位操作</td><td>避免&amp;和&amp;&amp;手误</td></tr><tr><td>camelcase</td><td>变量名只允许驼峰camelCase和UPPER_CASE风格</td><td></td></tr><tr><td>curly</td><td>单行代码块必须使用分号</td><td>防止潜在bug</td></tr><tr><td>eqeqeq</td><td>禁止使用==,!=</td><td>避免类型转换</td></tr><tr><td>es3</td><td>兼容IE 6/7/8/9</td><td></td></tr><tr><td>forin</td><td>内部必须使用hasOwnProperty</td><td>防止遍历原型链上的其它属性</td></tr><tr><td>freeze</td><td>禁止覆写原生对象</td><td></td></tr><tr><td>immend</td><td>(function(){}())</td><td></td></tr><tr><td>indent</td><td>2/4</td><td></td></tr><tr><td>latedef</td><td>禁止未定义而使用</td><td>防止潜在bug</td></tr><tr><td>newcap</td><td>类名首字母大写</td><td></td></tr><tr><td>noarg</td><td>禁止使用arguments.caller和arguments.callee</td><td>难以优化，且已经被废除</td></tr><tr><td>noempty</td><td>禁止出现空代码块</td><td></td></tr><tr><td>nonew</td><td>禁止调用构造函数而不赋值</td><td></td></tr><tr><td>plusplus</td><td>禁止使用++, –</td><td>不同语言含义不一致</td></tr><tr><td>quotmark</td><td>true/single/double</td><td></td></tr><tr><td>undef</td><td>禁止使用未定义的遍历</td><td></td></tr><tr><td>unused</td><td>禁止出现未使用的变量</td><td>设置为vars不检查函数参数</td></tr><tr><td>strict</td><td>所有的<strong>函数</strong>都会使用es5的严格模式</td><td></td></tr><tr><td>maxparams</td><td>最多的形参</td><td>5</td></tr><tr><td>maxdepth</td><td>嵌套深度</td><td></td></tr><tr><td>maxstatements</td><td>最多声明</td><td></td></tr><tr><td>maxcomplexity</td><td>cyclomatic complexity</td><td></td></tr><tr><td>maxlen</td><td>设置一行最大的长度</td><td></td></tr></tbody></table><h3 id="宽松选项-relaxing-options"><a href="#宽松选项-relaxing-options" class="headerlink" title="宽松选项(relaxing options)"></a>宽松选项(relaxing options)</h3><p>设置为true时，应用规则，对代码约束更宽松。</p><table><thead><tr><th>配置项</th><th>解释</th><th>说明</th></tr></thead><tbody><tr><td>asi</td><td>忽略句尾分号警告</td><td>扩展阅读：<a href="http://blog.izs.me/post/2353458699/an-open-letter-to-javascript-leaders-regarding" target="_blank" rel="noopener">1</a> , <a href="http://inimino.org/~inimino/blog/javascript_semicolons" target="_blank" rel="noopener">2</a></td></tr><tr><td>boss</td><td>会允许在if，for，while里面编写赋值语句</td><td>不检查判断条件中得赋值</td></tr><tr><td>debug</td><td>忽略debug语句</td><td></td></tr><tr><td>eqnull</td><td>允许 == null</td><td></td></tr><tr><td>esnext</td><td>允许ES6语法</td><td><a href="http://wiki.ecmascript.org/doku.php?id=harmony:specification_drafts" target="_blank" rel="noopener">ES6草案</a></td></tr><tr><td>evil</td><td>忽略evil警告</td><td></td></tr><tr><td>expr</td><td>在赋值或者函数调用的地方允许出现表达式</td><td>大部分情况是手误</td></tr><tr><td>funcscope</td><td>允许在控制流程if等中定义变量</td><td>默认为false</td></tr><tr><td>globalstrict</td><td>忽略全局使用strict的警告</td><td></td></tr><tr><td>iterator</td><td>忽略使用<strong>iterator</strong>属性警告</td><td>并非所有浏览器支持</td></tr><tr><td>lastsemic</td><td>仅允许单行代码块不使用分号</td><td></td></tr><tr><td>laxbreak</td><td>忽略不安全的换行告警</td><td></td></tr><tr><td>laxcomma</td><td>忽略逗号风格告警</td><td></td></tr><tr><td>loopfunc</td><td>忽略在循环中定义函数告警</td><td>建议设置为false</td></tr><tr><td>maxerr</td><td>设置JSHint最多警告数目</td><td>默认50</td></tr><tr><td>moz</td><td>表明这是Mozilla扩展</td><td><a href="https://developer.mozilla.org/en-US/docs/JavaScript/New_in_JavaScript/1.7" target="_blank" rel="noopener">New in JavaScript 1.7</a></td></tr><tr><td>multistr</td><td>忽略多行字符串告警</td><td></td></tr><tr><td>notypeof</td><td>忽略不正确的typeof比较</td><td>默认为false，不用管</td></tr><tr><td>proto</td><td>忽略使用<strong>proto</strong> 属性</td><td></td></tr><tr><td>scripturl</td><td>忽略使用”javascript:…”告警</td><td></td></tr><tr><td>shadow</td><td>忽略重复声明变量产生的告警</td><td></td></tr><tr><td>sub</td><td>忽略使用[]而不是.访问属性的告警</td><td></td></tr><tr><td>supernew</td><td>忽略使用诡异的构造函数告警</td><td><a href="http://www.jshint.com/docs/options/#supernew" target="_blank" rel="noopener">示例</a></td></tr><tr><td>validthis</td><td>忽略严格模式在非构造函数中使用this</td><td>函数内部使用</td></tr><tr><td>noyield</td><td>允许没有使用yield的generator function</td><td></td></tr></tbody></table><h3 id="环境配置-Environments"><a href="#环境配置-Environments" class="headerlink" title="环境配置(Environments)"></a>环境配置(Environments)</h3><table><thead><tr><th>配置项</th><th>说明</th></tr></thead><tbody><tr><td>browser</td><td>可以使用HTML5的新特性如FileReader等</td></tr><tr><td>couch</td><td>CouchDB</td></tr><tr><td>devel</td><td>可以使用穷人版的debug工具，比如console、alert</td></tr><tr><td>dojo</td><td>Dojo Toolkit</td></tr><tr><td>jquery</td><td>jquery</td></tr><tr><td>node</td><td>Node.js</td></tr><tr><td>nonstandard</td><td>允许流行而不标准的全局变量，比如escape和unescape</td></tr><tr><td>phantom</td><td><a href="http://phantomjs.org/" target="_blank" rel="noopener">PhantomJS</a></td></tr><tr><td>protypejs</td><td>protypejs</td></tr><tr><td>rhino</td><td><a href="http://www.mozilla.org/rhino/" target="_blank" rel="noopener">Rhino</a></td></tr><tr><td>worker</td><td>表明你的脚本运行在<a href="https://developer.mozilla.org/en/Using_web_workers" target="_blank" rel="noopener">Web Worker</a>中</td></tr><tr><td>wsh</td><td><a href="http://en.wikipedia.org/wiki/Windows_Script_Host" target="_blank" rel="noopener">Windows_Script_Host</a></td></tr><tr><td>yui</td><td><a href="http://yuilibrary.com/" target="_blank" rel="noopener">YUI</a></td></tr></tbody></table><h2 id="币须网的JSHint"><a href="#币须网的JSHint" class="headerlink" title="币须网的JSHint"></a>币须网的JSHint</h2><p><a href="http://www.coinxu.com" target="_blank" rel="noopener">币须网</a>作为国内第一家应用<strong>比特币多重签名</strong>技术的电子商务平台，后台全部使用Node.js搭建，在团队协作上也需要JSHint这样的工具来进行检查和约束。我们正在使用如下的配置：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">"bitwise"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"camelcase"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"curly"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"eqeqeq"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"es3"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"forin"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"freeze"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"immed"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"indent"</span>: <span class="number">2</span>,</span><br><span class="line"><span class="string">"latedef"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"newcap"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"noarg"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"noempty"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"nonbsp"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"nonew"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"plusplus"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"quotmark"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"undef"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"unused"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"strict"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"maxparams"</span>: <span class="number">5</span>,</span><br><span class="line"><span class="string">"maxdepth"</span>: <span class="number">8</span>,</span><br><span class="line"><span class="string">"maxstatements"</span>: <span class="number">50</span>,</span><br><span class="line"><span class="string">"maxcomplexity"</span>:<span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"asi"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"boss"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"debug"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"eqnull"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"esnext"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"evil"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"expr"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"funcscope"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"globalstrict"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"iterator"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"lastsemic"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"laxbreak"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"laxcomma"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"loopfunc"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"maxerr"</span>: <span class="number">50</span>,</span><br><span class="line"><span class="string">"multistr"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"notypeof"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"proto"</span>:<span class="literal">true</span>,</span><br><span class="line"><span class="string">"shadow"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"supernew"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"validthis"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"noyield"</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"node"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p><strong>强迫症</strong>每个人或多或少都有一点，沉溺于习惯求稳而不求变也是人之本性。但如果要突破自我，不求变通怕是成不了气候。再则善于运用标准化的工具也算得上一大进步，程序员尤其如此，如果偶然之间随手解救了团队和自己也算得上造福一方吧。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;p&gt;编程追求效率，却也讲究习惯。习惯改变之难，还真不能说&lt;code&gt;那就不是个事儿&lt;/code&gt;，在技术圈子尤甚。&lt;/p&gt;&lt;p&gt;当然，JavaScript
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>初识JavaScript Promises之二</title>
    <link href="http://yoursite.com/2014/07/15/%E5%88%9D%E8%AF%86JavaScript-Promises%E4%B9%8B%E4%BA%8C/"/>
    <id>http://yoursite.com/2014/07/15/初识JavaScript-Promises之二/</id>
    <published>2014-07-14T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><p>上一篇我们初步学习了JavaScript Promises，本篇将介绍Promise如何优雅地进行错误处理以及提升操作<strong>node.js风格</strong>[^1]的异步方法的逼格，没错就是使用<strong>promisify</strong>[^2]。</p><h2 id="异步编程中的错误处理"><a href="#异步编程中的错误处理" class="headerlink" title="异步编程中的错误处理"></a>异步编程中的错误处理</h2><p>人性的、理想的也正如很多编程语言中已经实现的错误处理方式应该是这样：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> val = <span class="built_in">JSON</span>.parse(fs.readFileSync(<span class="string">"file.json"</span>));</span><br><span class="line">&#125;<span class="keyword">catch</span>(<span class="built_in">SyntaxError</span> e) &#123;<span class="comment">//json语法错误</span></span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">"不符合json格式"</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span>(<span class="built_in">Error</span> e) &#123;<span class="comment">//其它类型错误</span></span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">"无法读取文件"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很遗憾，JavaScript并不支持上述方式，于是“聪明的猴子”很可能写出下面的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//code</span></span><br><span class="line">&#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">    <span class="keyword">if</span>( e <span class="keyword">instanceof</span> <span class="built_in">SyntaxError</span>) &#123;</span><br><span class="line">        <span class="comment">//handle</span></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//handle  </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>相信没人会喜欢第二段代码，不过传统的JavaScript也只能帮你到这里了。</p><p>上面的代码是同步模式，异步模式中的错误处理又是如何呢？</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fs.readFile(<span class="string">'file.json'</span>, <span class="string">'utf8'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(err)&#123;</span><br><span class="line"><span class="built_in">console</span>.error(<span class="string">"无法读取文件"</span>)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="keyword">var</span> json = <span class="built_in">JSON</span>.parese(data)</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line"><span class="built_in">console</span>.error(<span class="string">"不符合json格式"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>友情提醒：在node.js中你应该尽量避免使用同步方法。</p><p>仔细比较第一段和第三段的代码的差异会发现，如此简单的代码竟然用了三次缩进！如果再加入其它异步操作，邂逅<code>callback hell</code>是必然的了。</p><hr><h2 id="使用Promise进行错误处理"><a href="#使用Promise进行错误处理" class="headerlink" title="使用Promise进行错误处理"></a>使用Promise进行错误处理</h2><p>假设fs.readFileAsync是fs.readFile的Promise版本，这意味着什么呢，不妨回忆一下：</p><blockquote><ul><li>fs.readFileAsync方法的返回结果是一个Promise对象</li><li>fs.readFileAsync方法的返回结果拥有一个then方法</li><li>fs.readFileAsync方法接受参数与fs.readFile一致，除了最后一个回调函数</li></ul></blockquote><p>返回Promise对象意味着，执行fs.readFileAsync并不会立即执行异步操作，而是通过调用其then方法来执行，then方法接受的回调函数用于处理正确返回结果。所以使用fs.readFileAsync的使用方式如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Promise版本</span></span><br><span class="line">fs.readFileAsync(<span class="string">'file.json'</span>, <span class="string">'utf8'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>OK，让我们继续错误处理这个话题。由于<a href="http://promisesaplus.com/" target="_blank" rel="noopener">Promises/A+</a>标准对Promise对象只规定了唯一的then方法，没有专门针对catch或者error的方法，我们将继续使用<a href="https://github.com/petkaantonov/bluebird" target="_blank" rel="noopener">bluebird</a>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 带错误处理的Promise版本</span></span><br><span class="line">fs.readFileAsync(<span class="string">'file.json'</span>, <span class="string">'utf8'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;).catch(<span class="built_in">SyntaxError</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line"><span class="comment">//code here</span></span><br><span class="line">&#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line"><span class="comment">//code here</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>上面的代码没有嵌套回调，和本文开始的第一段代码的编写模式也基本一致。</p><h2 id="神奇的Promisify"><a href="#神奇的Promisify" class="headerlink" title="神奇的Promisify"></a>神奇的Promisify</h2><p>注：</p><p>下面我们看如何对fs.readFileAsync方法进行promisify，依然是使用bluebird。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">'bluebird'</span>)</span><br><span class="line">fs.readFileAsync = <span class="built_in">Promise</span>.promisify(fs.readFie, fs)</span><br></pre></td></tr></table></figure><p>怎么样，就是如此简单！对于bluebird它还有一个更强大的方法，那就是promisify的高级版本 <code>promisifyAll</code>，比如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">'bluebird'</span>)</span><br><span class="line"><span class="built_in">Promise</span>.promisifyAll(fs)</span><br></pre></td></tr></table></figure><p>执行完上面的代码之后，fs对象下所有的异步方法都会对应的生成一个Promise版本方法，比如fs.readFile对应fs.readFileAsync，fs.mkdir对应fs.mkdirAsync，以此类推。</p><p>另外要注意的就是，Promise版本的函数除了最后一个参数（回调函数），其它参数与原函数均一一对应，调用的时候别忘了传递原有的参数。</p><p>对fs的<code>promisification</code>还不能令我满足，我需要更神奇的魔法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// redis</span></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">"bluebird"</span>);</span><br><span class="line"><span class="built_in">Promise</span>.promisifyAll(<span class="built_in">require</span>(<span class="string">"redis"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// mongoose</span></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">"bluebird"</span>);</span><br><span class="line"><span class="built_in">Promise</span>.promisifyAll(<span class="built_in">require</span>(<span class="string">"mongoose"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// mongodb</span></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">"bluebird"</span>);</span><br><span class="line"><span class="built_in">Promise</span>.promisifyAll(<span class="built_in">require</span>(<span class="string">"mongodb"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// mysql</span></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">"bluebird"</span>);</span><br><span class="line"><span class="built_in">Promise</span>.promisifyAll(<span class="built_in">require</span>(<span class="string">"mysql/lib/Connection"</span>).prototype);</span><br><span class="line"><span class="built_in">Promise</span>.promisifyAll(<span class="built_in">require</span>(<span class="string">"mysql/lib/Pool"</span>).prototype);</span><br><span class="line"></span><br><span class="line"><span class="comment">// request</span></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">"bluebird"</span>);</span><br><span class="line"><span class="built_in">Promise</span>.promisifyAll(<span class="built_in">require</span>(<span class="string">"request"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// mkdir</span></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">"bluebird"</span>);</span><br><span class="line"><span class="built_in">Promise</span>.promisifyAll(<span class="built_in">require</span>(<span class="string">"mkdirp"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// winston</span></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">"bluebird"</span>);</span><br><span class="line"><span class="built_in">Promise</span>.promisifyAll(<span class="built_in">require</span>(<span class="string">"winston"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Nodemailer</span></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">"bluebird"</span>);</span><br><span class="line"><span class="built_in">Promise</span>.promisifyAll(<span class="built_in">require</span>(<span class="string">"nodemailer"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// pg</span></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">"bluebird"</span>);</span><br><span class="line"><span class="built_in">Promise</span>.promisifyAll(<span class="built_in">require</span>(<span class="string">"pg"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>少年，这下你颤抖了吗？</p><p>注：如果你正在使用mongoose，除了bluebird你可能还需要<a href="https://github.com/simongfxu/mongoomise" target="_blank" rel="noopener"><strong>mongoomise</strong></a>，它的优点在于：</p><blockquote><ul><li>能够接受任意的Promise Library (Q/when.js/RSVP/bluebird/es6-promise等等)</li><li>支持对多个数据库实例进行promisify</li><li>能够对Model自定义静态私有方法进行promisify，而bluebird.promisifyAll不支持</li><li>mongoomise + bluebird与仅使用bluebird性能相差无几，可能更好。</li></ul></blockquote><p>我们<a href="http://www.coinxu.com" target="_blank" rel="noopener"><strong>币须网</strong></a>已经在生产环境中使用mongoomise + bluebird，目前为止一切安好。</p><p>注：</p><ul><li><p>node.js风格函数指的是这样的一种异步函数，它接受的最后一个参数是异步操作完成之后的回调函数，这个回调函数的第一个参数接受执行错误的Error对象，第二个参数接受成功返回值）。</p></li><li><p><code>promisify</code>大概的意思就是根据一个<strong>node.js风格</strong>的异步方法生成另一个等价的Promise风格的方法（这个方法返回值是一个Promise，其它形参与原方法相同除了没有最后一个回调函数），这个名词我最早是看到bluebird使用。</p></li></ul><p>(未完待续 2014-07-15 23:40)</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;p&gt;上一篇我们初步学习了JavaScript Promises，本篇将介绍Promise如何优雅地进行错误处理以及提升操作&lt;strong&gt;node.js风
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>初识JavaScript Promises之一</title>
    <link href="http://yoursite.com/2014/06/28/%E5%88%9D%E8%AF%86JavaScript-Promises%E4%B9%8B%E4%B8%80/"/>
    <id>http://yoursite.com/2014/06/28/初识JavaScript-Promises之一/</id>
    <published>2014-06-27T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><p>JavaScript有很多槽点，嵌套回调怕是千夫所指。</p><p>很久之前，我一直使用async来处理JavaScript异步编程中的嵌套回调问题。当然我也大概的了解过一些其它旨在解决这些问题的类库，诸如EventProxy、Jscex、StepJS、thenjs。</p><p>当我第一次看到Promises规范的时候，我根本无法理解它所带来的好处。譬如每个初次学习Promises的人都见过如下的示例代码：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//callbacks</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">err, value</span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(err)&#123;</span><br><span class="line"><span class="comment">// do something</span></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//do other things with value</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Promises</span></span><br><span class="line">promise.then(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line"><span class="comment">//do something with value</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line"><span class="comment">//do other things with error</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p></p><p>很难相信上面的代码会让人对Promises刮目相看。不过正如<a href="https://github.com/petkaantonov/bluebird" target="_blank" rel="noopener">bluebird</a>作者Petka所说，上面的代码是<br><a href="https://twitter.com/PetkaAntonov/status/475274392461910016" target="_blank" rel="noopener">“最不诚实的比较”</a>。所以我恳请你把类似的代码从你的记忆中擦出吧。</p><p>不妨让我们再回到async的讨论上。async的问题在于它不能优雅地应对需求的变化，一旦业务逻辑有较大的变化，代码结构会进行大幅度的调整，而Promises却能够轻松的应对这种变化。待时机适宜我会进行详细的比较，首先让我们开始快速地了解Promises。</p><hr><h2 id="Promises是什么"><a href="#Promises是什么" class="headerlink" title="Promises是什么"></a>Promises是什么</h2><p>Promises象征着一个异步操作的最终结果。Promises交互主要通过它的then方法，then方法接受一个回调函数，这个回调函数接受执行成功的返回值或执行失败的错误原因，错误原因一般是Error对象。<strong>需要注意的是，then方法执行的返回值是一个Promise对象，而then方法接受的回调函数的返回值则可以是任意的JavaScript对象，包括Promises。基于这种机制，Promise对象的链式调用就起作用了。</strong></p><h2 id="Promises的状态"><a href="#Promises的状态" class="headerlink" title="Promises的状态"></a>Promises的状态</h2><p>Promise对象有三种状态：pending（初始状态）、fulfilled（成功执行）、rejected（执行出错）。pending状态的Promise对象可以转换到其它两种状态。</p><hr><p>上面的文本不够形象，不妨上些代码来加深对Promises的认识。</p><p>注：由于主流的JavaScript环境（包括NodeJS）对Promises/A+标准的实现差强人意，我的示例均使用了第三方类库<a href="https://github.com/petkaantonov/bluebird" target="_blank" rel="noopener">bluebird</a>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">'bluebird'</span>)</span><br><span class="line"><span class="comment">//改造fs.readFile为Promise版本</span></span><br><span class="line"><span class="keyword">var</span> readFileAsync = <span class="function"><span class="keyword">function</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line"><span class="comment">//返回一个Promise对象，初始状态pending</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">fulfill, reject</span>)</span>&#123;</span><br><span class="line">fs.readFile(path,  <span class="string">'utf8'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, content</span>)</span>&#123;</span><br><span class="line"><span class="comment">//由pending状态进入rejected状态</span></span><br><span class="line"><span class="keyword">if</span>(err)<span class="keyword">return</span> reject(err)</span><br><span class="line"><span class="comment">//由pending状态进入fulfilled状态</span></span><br><span class="line"><span class="keyword">return</span> fulfill(content)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//开始使用，调用其then方法，回调接受执行成功的返回值</span></span><br><span class="line">readFileAsync(<span class="string">'./promise-1.js'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">content</span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(content)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>看了上面的代码以后，是不是觉得Promises其实并不复杂呢。</p><p>OK，我们继续延续上面的代码，来简单比较一下传统回调和Promises的使用上的差别：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 简单比较一下传统方式和Promises方式</span></span><br><span class="line"><span class="comment">* 需求：读取两个文件并打印内容</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//callbacks</span></span><br><span class="line">fs.readFile(<span class="string">'./promise-1.js'</span>, <span class="string">'utf8'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, content1</span>)</span>&#123;</span><br><span class="line"><span class="comment">//嵌套一次</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'#'</span>, content1)</span><br><span class="line">fs.readFile(<span class="string">'./promise-1.js'</span>, <span class="string">'utf8'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, content2</span>)</span>&#123;</span><br><span class="line"> <span class="comment">//第二次嵌套</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'##'</span>, content2)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//Promises</span></span><br><span class="line">readFileAsync(<span class="string">'./promise-1.js'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">content1</span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'#'</span>, content1)</span><br><span class="line"><span class="comment">//这里返回一个Promise对象</span></span><br><span class="line"><span class="keyword">return</span> readFileAsync(<span class="string">'./promiscuitye-1.js'</span>)</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">content2</span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'##'</span>, content2)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p></p><p>上面的代码都没有错误处理，这是一个后果很严重的坏习惯。不过今天我们的重点不在这里，而是分析上下两段代码的主要区别。</p><p>第一段代码是传统的嵌套回调，在第二次打印的时候已经使用了两次缩进，而Promises链式调用then方法成功地避免了一次缩进（嵌套），维持了代码结构的相对平坦。上面的代码略显简陋，如果再加上错误处理，Promises毫无疑问将会大放光彩，有兴趣请关注后续章节。</p><p>本章写到这里就结束了，相信大家已经对Promises的有了一个初步认识。规范文档往往很难理解，我没有过多的描述规范，因为我相信代码最能够解释一切。不过对规范文档有兴趣的可以自行阅读参考链接。</p><p>最后我想强调的一点就是：<strong>Promises这种维持代码结构平坦的魔力在业务逻辑复杂多变的情况下是非常有用的</strong>。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote><ul><li><a href="https://github.com/promises-aplus/promises-spec" target="_blank" rel="noopener">Promises/A+ 标准</a></li><li><a href="https://github.com/petkaantonov/bluebird" target="_blank" rel="noopener">Bluebird</a></li></ul></blockquote><hr><p>未完待续(2014-06-28 00:59)</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;p&gt;JavaScript有很多槽点，嵌套回调怕是千夫所指。&lt;/p&gt;&lt;p&gt;很久之前，我一直使用async来处理JavaScript异步编程中的嵌套回调问题。
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>Ajax编码问题</title>
    <link href="http://yoursite.com/2012/11/11/Ajax-Encoding/"/>
    <id>http://yoursite.com/2012/11/11/Ajax-Encoding/</id>
    <published>2012-11-10T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><p>前些天看到一个关于Ajax编码的问题，当时被提问者的描述绕的都想不清楚，今天闲来没事就整理下。原文地址在<a href="http://segmentfault.com/q/1010000000130593" target="_blank" rel="noopener">这里</a>。</p><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>我的前端页面为GBK，所以待发送的数据肯定也为GBK，而由ajax的特性其在发送前其会被自动转换为utf-8<br>所以后台接收到的数据为utf-8的<br>然后我的后台页面编码为UTF-8，同时设置了response header中的编码参数也为UTF-8，那么前端收到的数据应该也是UTF-8<br>但前端页面为GBK，理论上来说这样会产生乱码，可是并没有，这是为什么呢？</p><p>提问者的描述有点混乱，而且各种绕，一不小心就会踩到提问者设的坑。</p><h2 id="如何解决"><a href="#如何解决" class="headerlink" title="如何解决"></a>如何解决</h2><p>彻底解决这个问题你首先需要了解以下几个知识点：</p><blockquote><ul><li>页面表单提交到后台的数据编码与页面编码一致</li><li>通过javascript提交到后台的数据都会被转换为utf-8格式</li></ul></blockquote><p>所以原则上这样理解，这个问题就差不多了：</p><pre><code>输入编码为UTF-8，后台以UTF-8方式输出，保证输入和输出一致那么自然就没有乱码问题。</code></pre><p>要让别人相信自己，首先得自己相信自己，我们先不妨来几个测试。另外问题描述既然提到了后台的文本编码，我们也需要重点测试一下。</p><h2 id="测试工作"><a href="#测试工作" class="headerlink" title="测试工作"></a>测试工作</h2><p>准备以下页面：</p><ul><li>主页面index.php</li><li>ajax后台页面utf8.php</li><li>ajax后台页面gbk.php</li></ul><h3 id="主页面-index-php，文本编码gbk"><a href="#主页面-index-php，文本编码gbk" class="headerlink" title="主页面 index.php，文本编码gbk"></a>主页面 index.php，文本编码gbk</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"gbk"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://s.segmentfault.com/js/jquery.js?12.11.5.1"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"ajax_send('utf8')"</span>&gt;</span>JS提交(utf-8)<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"ajax_send('gbk')"</span>&gt;</span>JS提交(gbk)<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> ajax_send = <span class="function"><span class="keyword">function</span>(<span class="params">encoding</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest(), params = <span class="built_in">encodeURI</span>(<span class="string">'t=编码'</span>)</span></span><br><span class="line"><span class="javascript">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">if</span>(<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status ==<span class="number">200</span>)</span></span><br><span class="line"><span class="javascript">alert(<span class="keyword">this</span>.responseText)</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="javascript">xhr.open(<span class="string">'POST'</span>,encoding + <span class="string">'.php'</span>,<span class="literal">true</span>)</span></span><br><span class="line"><span class="javascript">xhr.setRequestHeader(<span class="string">"Content-type"</span>, <span class="string">"application/x-www-form-urlencoded"</span>);</span></span><br><span class="line"><span class="undefined">xhr.send(params)</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="utf8-php，文本编码utf-8"><a href="#utf8-php，文本编码utf-8" class="headerlink" title="utf8.php，文本编码utf-8"></a>utf8.php，文本编码utf-8</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'content-type:text/html;charset=utf-8'</span>);</span><br><span class="line"><span class="keyword">echo</span> $_POST[<span class="string">'t'</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="gbk-php，与utf8-php内容相同，区别就是文本编码为gbk"><a href="#gbk-php，与utf8-php内容相同，区别就是文本编码为gbk" class="headerlink" title="gbk.php，与utf8.php内容相同，区别就是文本编码为gbk"></a>gbk.php，与utf8.php内容相同，区别就是文本编码为gbk</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'content-type:text/html;charset=utf-8'</span>);</span><br><span class="line"><span class="keyword">echo</span> $_POST[<span class="string">'t'</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>启动Web Server，打开页面，分别点击按钮，都正确的弹出了“编码”二字，没有发现乱码现象。</p><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>对于页面通过JS提交的数据：</p><blockquote><ul><li>后台接口，只要保证输入输出的编码一致，提交的数据就会有乱码产生</li><li>后台文件的文本编码以及前端页面的编码不会导致提交的数据返回时乱码，只要输入输出编码一致</li></ul></blockquote><p>对于以上两个结论，读者还可以这样测试。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'content-type:text/html;charset=gbk'</span>);</span><br><span class="line"><span class="keyword">echo</span> iconv(<span class="string">"utf-8"</span>,<span class="string">"gbk"</span>,$_POST[<span class="string">'t'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>先将输入转码为gbk，然后输出同时设置为页面编码，这样也不会有乱码产生，但是服务端多了一道转码处理，效率不及直接输出utf-8。</p><p>对于后台附加的一些输出，比如在gbk.php中最后加一行</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">"中文"</span>;</span><br></pre></td></tr></table></figure><p>这种情况会不会导致乱码呢？读者可以自己测试一下。</p><h2 id="深入"><a href="#深入" class="headerlink" title="深入"></a>深入</h2><p>稍微搞过前端的人都知道，使用script标签引入脚本的时候，有一个属性是charset用于指定脚本文件的编码。当页面编码与引入脚本的文本编码不一致的时候需要显式指定，否则就会容易造成乱码。</p><p>现在我们仔细对比这两种场景的处理方式，不就是一模一样吗？只要保证输入输出的编码一致即可。唯一的区别就是一个是静态资源，一个是动态接口。</p><p>你有可能会问，当输入输出指定的编码不一致时是不是就一定是乱码呢，浏览器又该如何解析呢？</p><p>这个时候你就该来<a href="http://ued.taobao.com/blog/2011/08/26/encode-war/" target="_blank" rel="noopener">这里</a>看看了。</p><p>光棍节写博客，看来我是真光棍，真屌丝。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;p&gt;前些天看到一个关于Ajax编码的问题，当时被提问者的描述绕的都想不清楚，今天闲来没事就整理下。原文地址在&lt;a href=&quot;http://segment
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>iOS UIWebView Class Reference</title>
    <link href="http://yoursite.com/2012/10/30/iOS-UIWebView-Class-Reference/"/>
    <id>http://yoursite.com/2012/10/30/iOS-UIWebView-Class-Reference/</id>
    <published>2012-10-29T16:00:00.000Z</published>
    <updated>2017-12-21T23:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --><p><a href="https://developer.apple.com/library/ios/#documentation/UIKit/Reference/UIWebView_Class/Reference/Reference.html" target="_blank" rel="noopener">原文地址</a></p><h2 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h2><h3 id="allowsInlineMediaPlayback"><a href="#allowsInlineMediaPlayback" class="headerlink" title="allowsInlineMediaPlayback"></a>allowsInlineMediaPlayback</h3><p><strong style="color:red">前端重点关注</strong></p><p>是否允许页内播放视频，默认值NO，使用原生的全屏控制。</p><p>使用页面播放需要设置此属性为YES，并且video 元素要加上 <code>webkit-playsinline</code>属性。</p><h3 id="canGoBack"><a href="#canGoBack" class="headerlink" title="canGoBack"></a>canGoBack</h3><p>是否可以后退，只读属性</p><h3 id="canGoForward"><a href="#canGoForward" class="headerlink" title="canGoForward"></a>canGoForward</h3><p>是否可以前进，只读属性</p><h3 id="dataDetectorTypes"><a href="#dataDetectorTypes" class="headerlink" title="dataDetectorTypes"></a>dataDetectorTypes</h3><p>在webview被转换为可点击的URL内容的数据类型。</p><p>使用此属性可以指定譬如<code>http链接</code>，<code>Email地址</code>，<code>电话号码</code>等内容将自动转换为可点击的链接。当点击以后，webview寻找相应的应用程序来处理。</p><h3 id="delegate"><a href="#delegate" class="headerlink" title="delegate"></a>delegate</h3><p>委托，用于回调通知页面的加载状态，比如已经打开、打开完成或打开错误等。</p><h3 id="keyboardDisplayRequiresUserAction"><a href="#keyboardDisplayRequiresUserAction" class="headerlink" title="keyboardDisplayRequiresUserAction"></a>keyboardDisplayRequiresUserAction</h3><p><strong style="color:red">前端重点关注</strong></p><p>显示键盘是否一定需要用户动作，默认值为YES，也就是用户必须主动点击可输入的表单元素以后才会显示键盘。</p><p>设置为NO以后，页面可以通过JS脚本的<code>focus</code>事件显示键盘。</p><h3 id="loading"><a href="#loading" class="headerlink" title="loading"></a>loading</h3><p>webview是否还在加载，只读属性</p><h3 id="mediaPlaybackAllowsAirPlay"><a href="#mediaPlaybackAllowsAirPlay" class="headerlink" title="#mediaPlaybackAllowsAirPlay"></a>#mediaPlaybackAllowsAirPlay</h3><p><strong style="color:red">前端重点关注</strong></p><p>媒体播放是否允许<code>Air Play</code>???默认值为YES</p><h3 id="mediaPlaybackRequiresUserAction"><a href="#mediaPlaybackRequiresUserAction" class="headerlink" title="mediaPlaybackRequiresUserAction"></a>mediaPlaybackRequiresUserAction</h3><p><strong style="color:red">前端重点关注</strong></p><p>媒体播放是否需要用户动作主动触发，默认值为YES。也就是说默认情况无法自动播放音频和视频。</p><p>那么默认设置下是不是一定无法自动播放呢？StackOverflow上找到一个<a href="http://stackoverflow.com/questions/4259928/how-can-i-autoplay-media-in-ios-4-2-1-mobile-safari" target="_blank" rel="noopener">方法</a>解决此问题（没有测试）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ifr = <span class="built_in">document</span>.createElement(<span class="string">"iframe"</span>);</span><br><span class="line">ifr.setAttribute(<span class="string">'src'</span>, <span class="string">"http://mysite.com/myvideo.mp4"</span>);</span><br><span class="line">ifr.setAttribute(<span class="string">'width'</span>, <span class="string">'1px'</span>);</span><br><span class="line">ifr.setAttribute(<span class="string">'height'</span>, <span class="string">'1px'</span>);</span><br><span class="line">ifr.setAttribute(<span class="string">'scrolling'</span>, <span class="string">'no'</span>);</span><br><span class="line">ifr.style.border=<span class="string">"0px"</span>;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(ifr);</span><br></pre></td></tr></table></figure><h3 id="request"><a href="#request" class="headerlink" title="request"></a>request</h3><p>webview当前请求的URL，只读属性</p><h3 id="scalesPageToFit"><a href="#scalesPageToFit" class="headerlink" title="scalesPageToFit"></a>scalesPageToFit</h3><p>指定页面是否按比例缩放适应webview，并且用户可以更改缩放比例。默认值为NO，用户不能更改缩放比例。</p><h3 id="scrollView"><a href="#scrollView" class="headerlink" title="scrollView"></a>scrollView</h3><p>webview关联的scroll view，只读属性</p><h3 id="suppressesIncrementalRendering"><a href="#suppressesIncrementalRendering" class="headerlink" title="suppressesIncrementalRendering"></a>suppressesIncrementalRendering</h3><p>当页面完全加载到内存以后，webview是否禁止增量内容渲染，默认值为NO</p><p>iOS 6.0版本支持</p><p>##实例方法</p><h3 id="goBack"><a href="#goBack" class="headerlink" title="goBack"></a>goBack</h3><p>加载历史记录当前页之前的页面</p><h3 id="goForward"><a href="#goForward" class="headerlink" title="goForward"></a>goForward</h3><p>加载历史记录当前页之后的页面</p><h3 id="loadData-MIMEType-textEncodingName-baseURL"><a href="#loadData-MIMEType-textEncodingName-baseURL" class="headerlink" title="loadData:MIMEType:textEncodingName:baseURL"></a>loadData:MIMEType:textEncodingName:baseURL</h3><p>设置页面内容，MIMIE type，编码，URL</p><h3 id="loadHTMLString-baseURL"><a href="#loadHTMLString-baseURL" class="headerlink" title="loadHTMLString:baseURL:"></a>loadHTMLString:baseURL:</h3><p>设置页面内容</p><h3 id="loadRequest"><a href="#loadRequest" class="headerlink" title="loadRequest"></a>loadRequest</h3><p>根据指定的URL进行异步连接</p><h3 id="reload"><a href="#reload" class="headerlink" title="reload"></a>reload</h3><p>重新载入当前页</p><h3 id="stopLoading"><a href="#stopLoading" class="headerlink" title="stopLoading"></a>stopLoading</h3><p>取消当前页的加载</p><h3 id="stringByEvaluatingJavaScriptFromString"><a href="#stringByEvaluatingJavaScriptFromString" class="headerlink" title="stringByEvaluatingJavaScriptFromString"></a>stringByEvaluatingJavaScriptFromString</h3><p><strong>前端重点关注</strong></p><p>在页面加载完成以后运行JavaScript脚本，运行脚本有如下注意事项：</p><ul><li>脚本运行不得超过10秒</li><li>将要执行的脚本内存分配不得超过10M</li></ul><p><a href="http://url.cn/7Vf4bx" target="_blank" rel="noopener">这里</a>有一个比较详细的教程可以参考</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun Feb 11 2018 16:03:44 GMT+0800 (中国标准时间) --&gt;&lt;p&gt;&lt;a href=&quot;https://developer.apple.com/library/ios/#documentation/UIKit/Refer
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
</feed>
